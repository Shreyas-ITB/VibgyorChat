<div class="flex flex-col h-screen" style="background-color: var(--bg-primary); position: relative;" ng-click="closeThemeDropdown(); closeBackupDropdown(); hideContextMenu()">
  <!-- Mosaic Particle Background -->
  <div class="mosaic-bg" id="chatMosaicBg"></div>

  <!-- Modern Header (Hidden on mobile when in chat view) -->
  <nav class="px-6 py-4 flex items-center justify-between mobile-hide-in-chat" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); position: relative; z-index: 10;">
    <div class="flex items-center space-x-4">
      <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg" style="background-color: var(--text-primary);">
        <svg class="w-6 h-6" style="color: var(--bg-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </div>
      <div>
        <h1 class="text-xl font-bold text-white">VibgyorChat</h1>
        <p class="text-xs text-gray-400">Modern messaging experience</p>
      </div>
    </div>

    <div class="flex items-center space-x-4">
      <!-- Socket Connection Status - Pill Shape -->
      <div class="flex items-center space-x-2 backdrop-blur-sm rounded-full px-3 py-1.5 border" style="background-color: #000000; border-color: var(--border-color);">
        <div 
          ng-class="socketConnected ? 'bg-green-500 animate-pulse-soft' : 'bg-red-500 animate-pulse-soft'"
          class="w-2 h-2 rounded-full"
        ></div>
        <span 
          ng-class="socketConnected ? 'text-green-400' : 'text-red-400'"
          class="text-xs font-medium"
        >
          {{ socketConnected ? 'Connected' : 'Reconnecting...' }}
        </span>
      </div>
      
      <button
        ng-click="toggleProfilePopup()"
        class="flex items-center space-x-3 rounded-full px-4 py-2 transition-colors duration-200"
        style="background-color: #000000; color: var(--text-primary);"
      >
        <img
          ng-src="{{ currentUser.profile_picture_url || getProfilePicture(currentUser.profile_picture) }}"
          auth-image="{{ currentUser.profile_picture_url || getProfilePicture(currentUser.profile_picture) }}"
          alt="{{ currentUser.username }}"
          class="w-8 h-8 rounded-full ring-2"
          style="--tw-ring-color: var(--text-primary);"
        >
        <span class="text-sm font-medium text-white">
          {{ currentUser.name || currentUser.username || currentUser.email }}
        </span>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Profile Popup -->
  <div ng-if="showProfilePopup" class="fixed inset-0 z-50 flex items-center justify-center">
    <!-- Backdrop -->
    <div 
      ng-click="closeProfilePopup()" 
      class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"
    ></div>
    
    <!-- Profile Card -->
    <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
      <!-- Close Button -->
      <button 
        ng-click="closeProfilePopup()"
        class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Header -->
      <div class="text-center mb-6">
        <h2 class="text-xl font-bold text-white">Your Profile</h2>
      </div>

      <!-- Profile Picture -->
      <div class="text-center mb-6">
        <div class="relative inline-block">
          <img
            ng-if="!editingProfile || !editForm.profilePicturePreview"
            ng-src="{{ currentUser.profile_picture_url || getProfilePicture(currentUser.profile_picture) }}"
            auth-image="{{ currentUser.profile_picture_url || getProfilePicture(currentUser.profile_picture) }}"
            alt="{{ currentUser.username }}"
            class="w-24 h-24 rounded-full ring-4 mx-auto"
            style="--tw-ring-color: var(--text-primary);"
          >
          <img
            ng-if="editingProfile && editForm.profilePicturePreview"
            ng-src="{{ editForm.profilePicturePreview }}"
            alt="Profile Preview"
            class="w-24 h-24 rounded-full ring-4 mx-auto object-cover"
            style="--tw-ring-color: var(--text-primary);"
          >
          <button 
            ng-if="editingProfile"
            ng-click="triggerProfilePictureUpload()"
            class="absolute bottom-0 right-0 p-2 rounded-full transition-colors duration-200"
            style="background-color: var(--text-primary); color: var(--bg-primary);"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
          </button>
          <button 
            ng-if="!editingProfile"
            ng-click="startEditProfile()"
            class="absolute bottom-0 right-0 p-2 rounded-full transition-colors duration-200"
            style="background-color: var(--text-primary); color: var(--bg-primary);"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
          </button>
          <!-- Hidden file input -->
          <input 
            type="file" 
            id="editProfilePictureInput" 
            accept="image/*" 
            style="display: none;" 
            onchange="angular.element(this).scope().onEditProfilePictureChange(event)"
          >
        </div>
        
        <!-- Remove Photo Button (only show in edit mode if there's a preview) -->
        <div ng-if="editingProfile && editForm.profilePicturePreview" class="mt-2">
          <button 
            type="button"
            ng-click="removeEditProfilePicture()"
            class="text-sm text-red-400 hover:text-red-300 transition-colors duration-200"
          >
            Remove Photo
          </button>
        </div>
        
        <!-- Upload instruction text -->
        <div ng-if="editingProfile && !editForm.profilePicturePreview" class="mt-2">
          <p class="text-xs text-gray-500">Click the pencil icon to upload a new photo</p>
        </div>
      </div>

      <!-- User Info -->
      <div class="space-y-4">
        <!-- Name -->
        <div ng-if="!editingProfile" class="bg-gray-800 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <label class="block text-xs font-medium text-gray-400 mb-1">Name</label>
              <p class="text-white text-sm">{{ currentUser.name || currentUser.full_name || 'No name set' }}</p>
            </div>
            <button ng-click="startEditProfile()" class="text-gray-400 hover:text-white transition-colors duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
              </svg>
            </button>
          </div>
        </div>

        <div ng-if="editingProfile" class="bg-gray-800 rounded-lg p-3">
          <label class="block text-xs font-medium text-gray-400 mb-1">Name</label>
          <input 
            type="text" 
            ng-model="editForm.name" 
            class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent"
            style="--tw-ring-color: var(--text-primary);"
            placeholder="Enter your name"
          >
        </div>

        <!-- Username -->
        <div ng-if="!editingProfile" class="bg-gray-800 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <label class="block text-xs font-medium text-gray-400 mb-1">Username</label>
              <p class="text-sm" style="color: var(--text-secondary);">@{{ currentUser.username || 'username' }}</p>
            </div>
            <button ng-click="startEditProfile()" class="text-gray-400 hover:text-white transition-colors duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
              </svg>
            </button>
          </div>
        </div>

        <div ng-if="editingProfile" class="bg-gray-800 rounded-lg p-3">
          <label class="block text-xs font-medium text-gray-400 mb-1">Username</label>
          <div class="relative">
            <input 
              type="text" 
              ng-model="editForm.username" 
              ng-change="checkUsernameAvailability()"
              class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent"
              style="--tw-ring-color: var(--text-primary);"
              placeholder="Enter username"
            >
            <div ng-if="checkingUsername" class="absolute right-3 top-1/2 transform -translate-y-1/2">
              <div class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
            </div>
          </div>
          <div ng-if="usernameAvailable === true" class="text-green-400 text-xs mt-1 flex items-center">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            Username is available
          </div>
          <div ng-if="usernameAvailable === false" class="text-red-400 text-xs mt-1 flex items-center">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
            Username is not available
          </div>
        </div>

        <!-- Email -->
        <div class="bg-gray-800 rounded-lg p-3">
          <label class="block text-xs font-medium text-gray-400 mb-1">Email</label>
          <p class="text-white text-sm">{{ currentUser.email }}</p>
        </div>

        <!-- Join Date -->
        <div class="bg-gray-800 rounded-lg p-3">
          <label class="block text-xs font-medium text-gray-400 mb-1">Member Since</label>
          <p class="text-white text-sm">
            {{ formatJoinDate(currentUser.created_at) }}
          </p>
        </div>

        <!-- Action Buttons -->
        <div ng-if="!editingProfile" class="flex space-x-3 pt-4">
          <button 
            ng-click="startEditProfile()"
            class="flex-1 py-2 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
            style="background-color: var(--text-primary); color: var(--bg-primary);"
          >
            Edit Profile
          </button>
          <button 
            ng-click="logout()"
            class="flex-1 py-2 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
            style="background-color: var(--error-color); color: white;"
          >
            Logout
          </button>
        </div>

        <div ng-if="editingProfile" class="flex space-x-3 pt-4">
          <button 
            ng-click="cancelEditProfile()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="saveProfile()"
            ng-disabled="!editForm.name.trim() || !editForm.username.trim() || usernameAvailable === false"
            class="flex-1 py-2 px-4 rounded-lg transition-colors duration-200 text-sm font-medium disabled:bg-gray-600 disabled:cursor-not-allowed"
            style="background-color: var(--text-primary); color: var(--bg-primary);"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex overflow-hidden relative">
    <!-- Desktop: Left Sidebar -->
    <div class="w-16 border-r flex flex-col items-center py-4 left-nav-bar" ng-class="{'mobile-hide': isMobile}" style="background-color: #000000; border-color: var(--border-color);">
      <!-- Navigation Items -->
      <div class="flex flex-col space-y-4">
        <!-- Chats -->
        <button
          ng-click="setSidebarView('chats')"
          ng-class="{ 'text-gray-400 hover:text-white hover:bg-gray-800': sidebarView !== 'chats' }"
          ng-style="sidebarView === 'chats' ? {'background-color': 'var(--text-primary)', 'color': 'var(--bg-primary)'} : {}"
          class="w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-200 relative"
          title="Chats"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <!-- Unread count badge for chats -->
          <span ng-if="chatUnreadCount > 0" class="sidebar-unread-badge">
            {{ formatUnreadCount(chatUnreadCount) }}
          </span>
        </button>

        <!-- Groups -->
        <button
          ng-click="setSidebarView('groups')"
          ng-class="{ 'text-gray-400 hover:text-white hover:bg-gray-800': sidebarView !== 'groups' }"
          ng-style="sidebarView === 'groups' ? {'background-color': 'var(--text-primary)', 'color': 'var(--bg-primary)'} : {}"
          class="w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-200 relative"
          title="Groups"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <!-- Unread count badge for groups -->
          <span ng-if="groupUnreadCount > 0" class="sidebar-unread-badge">
            {{ formatUnreadCount(groupUnreadCount) }}
          </span>
        </button>
      </div>

      <!-- Bottom Items -->
      <div class="flex-1 flex flex-col justify-end">
        <!-- Settings -->
        <button
          ng-click="setSidebarView('settings')"
          ng-class="{ 'text-gray-400 hover:text-white hover:bg-gray-800': sidebarView !== 'settings' }"
          ng-style="sidebarView === 'settings' ? {'background-color': 'var(--text-primary)', 'color': 'var(--bg-primary)'} : {}"
          class="w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-200"
          title="Settings"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Desktop: Modern Sidebar -->
    <div 
      class="w-1/3 max-w-md border-r flex flex-col desktop-sidebar" 
      ng-class="{'mobile-hide': isMobile}"
      style="background-color: var(--bg-secondary); border-color: var(--border-color); position: relative; z-index: 10;"
    >
      <!-- Search Section -->
      <div class="p-6 border-b" style="border-color: var(--border-color);">
        <div class="relative mb-4">
          <input
            type="text"
            ng-model="searchQuery"
            ng-change="searchContacts()"
            placeholder="Search chats, users, or join groups..."
            class="w-full border rounded-xl px-4 py-3 pl-12 placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
            style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
          >
          <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>

        <!-- Filter Tabs (only show when not searching and not in settings) -->
        <div ng-if="(!searchQuery || searchQuery.trim().length === 0) && sidebarView !== 'settings'" class="flex space-x-1 rounded-lg p-1 relative overflow-hidden" style="background-color: #000000;">
          <!-- Animated background -->
          <div 
            class="absolute top-1 bottom-1 rounded-md transition-all duration-300 ease-in-out"
            style="background-color: var(--text-primary);"
            ng-style="{
              'left': (sidebarView === 'chats' ? filter : groupFilter) === 'all' ? '4px' : ((sidebarView === 'chats' ? filter : groupFilter) === 'muted' ? 'calc(33.33% + 2px)' : 'calc(66.66% + 0px)'),
              'width': 'calc(33.33% - 4px)'
            }"
          ></div>
          
          <button
            ng-click="sidebarView === 'chats' ? filterContacts('all') : filterGroups('all')"
            ng-class="{ 'text-gray-400 hover:text-white': (sidebarView === 'chats' ? filter : groupFilter) !== 'all' }"
            ng-style="(sidebarView === 'chats' ? filter : groupFilter) === 'all' ? {'color': 'var(--bg-primary)'} : {}"
            class="flex-1 px-1.5 py-2 rounded-md text-xs font-medium transition-colors duration-200 relative z-10 min-w-0"
          >
            <span class="block truncate">All</span>
          </button>
          <button
            ng-click="sidebarView === 'chats' ? filterContacts('muted') : filterGroups('muted')"
            ng-class="{ 'text-gray-400 hover:text-white': (sidebarView === 'chats' ? filter : groupFilter) !== 'muted' }"
            ng-style="(sidebarView === 'chats' ? filter : groupFilter) === 'muted' ? {'color': 'var(--bg-primary)'} : {}"
            class="flex-1 px-1.5 py-2 rounded-md text-xs font-medium transition-colors duration-200 relative z-10 min-w-0"
          >
            <span class="block truncate">Muted</span>
          </button>
          <button
            ng-click="sidebarView === 'chats' ? filterContacts('favorites') : filterGroups('favorites')"
            ng-class="{ 'text-gray-400 hover:text-white': (sidebarView === 'chats' ? filter : groupFilter) !== 'favorites' }"
            ng-style="(sidebarView === 'chats' ? filter : groupFilter) === 'favorites' ? {'color': 'var(--bg-primary)'} : {}"
            class="flex-1 px-1.5 py-2 rounded-md text-xs font-medium transition-colors duration-200 relative z-10 min-w-0"
          >
            <span class="block truncate">Favorites</span>
          </button>
        </div>
      </div>

      <!-- Contacts List -->
      <div class="flex-1 overflow-y-auto scrollbar-thin">
        <!-- Loading State -->
        <div ng-if="loading" class="p-6 text-center">
          <div class="animate-spin w-8 h-8 border-2 border-t-transparent rounded-full mx-auto mb-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
          <p class="text-gray-400">Loading conversations...</p>
        </div>

        <!-- Search Results -->
        <div ng-if="!loading && searchQuery.trim().length > 0">
          <!-- Searching State -->
          <div ng-if="isSearching" class="p-6 text-center">
            <div class="animate-spin w-6 h-6 border-2 border-t-transparent rounded-full mx-auto mb-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
            <p class="text-gray-400 text-sm">Searching...</p>
          </div>

          <!-- Search Results -->
          <div ng-if="!isSearching">
            <!-- Your Contacts Results -->
            <div ng-if="searchResults.contacts && searchResults.contacts.length > 0" class="mb-6">
              <div class="px-4 py-3">
                <h3 class="text-lg font-bold text-white">Your Contacts</h3>
              </div>
              <div class="px-3 py-2">
                <div
                  ng-repeat="contact in searchResults.contacts"
                  ng-click="selectContactMobile(contact); clearSearch();"
                  ng-right-click="showSearchContactMenu($event, contact)"
                  ng-class="{ 'hover:bg-gray-800': !selectedContact || selectedContact.email !== contact.email }"
                  ng-style="selectedContact && selectedContact.email === contact.email ? {'background-color': 'rgba(255, 255, 255, 0.1)', 'border-color': 'var(--text-primary)'} : {}"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 group"
                >
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getProfilePicture(contact.profile_picture) }}"
                        auth-image="{{ getProfilePicture(contact.profile_picture) }}"
                        alt="{{ contact.username }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700 transition-all duration-200"
                      >
                      <div
                        class="absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-gray-900"
                        ng-class="{
                          'bg-green-500': contact.online && !contact.idle,
                          'bg-yellow-500': contact.idle,
                          'bg-gray-500': !contact.online && !contact.idle
                        }"
                      ></div>
                    </div>

                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-white truncate">
                        {{ contact.name || contact.username }}
                      </h3>
                      <p class="text-xs text-gray-400 truncate">
                        @{{ contact.username }}
                      </p>
                    </div>

                    <!-- Remove Contact Button -->
                    <button
                      ng-click="showRemoveContactConfirmation(contact); $event.stopPropagation()"
                      class="text-xs px-3 py-1.5 rounded-lg transition-all duration-200 flex items-center space-x-1.5 bg-red-500/10 text-red-500 hover:bg-red-500/20 border border-red-500/30"
                      title="Remove from contacts"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                      </svg>
                      <span>Remove</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Global Users Results -->
            <div ng-if="searchResults.global && searchResults.global.length > 0" class="mb-6">
              <div class="px-4 py-3">
                <h3 class="text-lg font-bold text-white">Global</h3>
              </div>
              <div class="px-3 py-2">
                <div
                  ng-repeat="user in searchResults.global"
                  class="p-4 rounded-xl border border-transparent mb-2 bg-gray-800/50 hover:bg-gray-800/70 transition-all duration-200"
                >
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getProfilePicture(user.profile_picture) }}"
                        auth-image="{{ getProfilePicture(user.profile_picture) }}"
                        alt="{{ user.username }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700"
                      >
                    </div>

                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-white truncate">
                        {{ user.name || user.username }}
                      </h3>
                      <p class="text-xs text-gray-400 truncate">
                        @{{ user.username }}
                      </p>
                    </div>

                    <button
                      ng-click="addToContacts(user)"
                      ng-disabled="addingToContacts[user.email]"
                      class="add-contact-btn disabled:opacity-50 disabled:cursor-not-allowed text-xs px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2 font-medium"
                    >
                      <svg ng-if="!addingToContacts[user.email]" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                      </svg>
                      <span ng-if="addingToContacts[user.email]" class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                      <span ng-if="!addingToContacts[user.email]">Add to Contacts</span>
                      <span ng-if="addingToContacts[user.email]">Adding...</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Group ID Match - Join Group -->
            <div ng-if="searchResults.groupIdMatch" class="mb-6">
              <div class="px-4 py-3">
                <h3 class="text-lg font-bold text-white">Group ID</h3>
              </div>
              <div class="px-3 py-2">
                <!-- Already a member -->
                <div ng-if="searchResults.groupIdMatch.alreadyMember" class="p-4 rounded-xl border border-transparent mb-2 bg-gray-800/50">
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getGroupPicture(searchResults.groupIdMatch.group) }}"
                        alt="{{ searchResults.groupIdMatch.group.name }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700"
                      >
                    </div>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-white truncate">{{ searchResults.groupIdMatch.group.name }}</h3>
                      <p class="text-xs text-green-400">You are already a member</p>
                    </div>
                    <button
                      ng-click="selectGroupMobile(searchResults.groupIdMatch.group); clearSearch();"
                      class="text-xs px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2 font-medium"
                      style="background-color: var(--text-primary); color: var(--bg-primary);"
                    >
                      <span>Open</span>
                    </button>
                  </div>
                </div>
                
                <!-- Not a member - Join option -->
                <div ng-if="!searchResults.groupIdMatch.alreadyMember" class="p-4 rounded-xl border border-transparent mb-2 bg-gray-800/50">
                  <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center ring-2 ring-gray-700">
                      <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-white">Join Group</h3>
                      <p class="text-xs text-gray-400 truncate font-mono">{{ searchResults.groupIdMatch.id }}</p>
                    </div>
                    <button
                      ng-click="joinGroupById(searchResults.groupIdMatch.id)"
                      ng-disabled="joiningGroup"
                      class="text-xs px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                      style="background-color: var(--success-color); color: white;"
                    >
                      <svg ng-if="!joiningGroup" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                      </svg>
                      <span ng-if="joiningGroup" class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                      <span ng-if="!joiningGroup">Join</span>
                      <span ng-if="joiningGroup">Joining...</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Groups Results -->
            <div ng-if="searchResults.groups && searchResults.groups.length > 0" class="mb-6">
              <div class="px-4 py-3">
                <h3 class="text-lg font-bold text-white">Groups</h3>
              </div>
              <div class="px-3 py-2">
                <div
                  ng-repeat="group in searchResults.groups"
                  ng-click="selectGroupMobile(group); clearSearch();"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 hover:bg-gray-800"
                >
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getGroupPicture(group) }}"
                        alt="{{ group.name }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700"
                      >
                    </div>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-sm font-semibold text-white truncate">{{ group.name }}</h3>
                      <p class="text-xs text-gray-400 truncate">{{ group.members_count }} members</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Messages Results -->
            <div ng-if="searchResults.messages && searchResults.messages.length > 0" class="mb-6">
              <div class="px-4 py-3">
                <h3 class="text-lg font-bold text-white">Messages</h3>
              </div>
              <div class="px-3 py-2">
                <div
                  ng-repeat="result in searchResults.messages | limitTo:20"
                  ng-click="openMessageResult(result)"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 hover:bg-gray-800"
                >
                  <div class="flex items-start space-x-3">
                    <div class="relative flex-shrink-0">
                      <img
                        ng-src="{{ result.conversationType === 'group' ? getGroupPicture(result.conversation) : getProfilePicture(result.conversation.profile_picture) }}"
                        ng-if="result.conversationType === 'group'"
                        alt="{{ result.conversation.name }}"
                        class="w-10 h-10 rounded-full ring-2 ring-gray-700"
                      >
                      <img
                        ng-src="{{ getProfilePicture(result.conversation.profile_picture) }}"
                        auth-image="{{ getProfilePicture(result.conversation.profile_picture) }}"
                        ng-if="result.conversationType === 'contact'"
                        alt="{{ result.conversation.name }}"
                        class="w-10 h-10 rounded-full ring-2 ring-gray-700"
                      >
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-white truncate">
                          {{ result.conversationType === 'group' ? result.conversation.name : (result.conversation.name || result.conversation.username) }}
                        </h3>
                        <span class="text-xs text-gray-500">{{ result.message.created_at | discordTimeCompact }}</span>
                      </div>
                      <p class="text-xs text-gray-400 contact-message-tight">{{ result.message.sender_name || 'Unknown' }}</p>
                      <p class="text-xs text-gray-300 line-clamp-2 contact-message-tight">{{ result.message.content }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Results -->
            <div ng-if="!isSearching && !searchResults.groupIdMatch && (!searchResults.contacts || searchResults.contacts.length === 0) && (!searchResults.global || searchResults.global.length === 0) && (!searchResults.groups || searchResults.groups.length === 0) && (!searchResults.messages || searchResults.messages.length === 0)" class="p-6 text-center">
              <svg class="w-16 h-16 text-gray-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <p class="text-gray-400">No results found for "{{ searchQuery }}"</p>
              <p class="text-gray-500 text-sm mt-2" ng-if="isEmployee()">Try searching for contacts, groups, messages, or enter a group ID to join</p>
              <p class="text-gray-500 text-sm mt-2" ng-if="!isEmployee()">Try searching for groups, messages, or enter a group ID to join</p>
              <p class="text-yellow-500 text-sm mt-3" ng-if="!isEmployee()">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                User search is restricted to employees only
              </p>
            </div>
          </div>
        </div>
        <!-- Regular Contacts List (when not searching) -->
        <div ng-if="!loading && (!searchQuery || searchQuery.trim().length === 0)">
          <!-- Chats View -->
          <div ng-if="sidebarView === 'chats'">
            <div ng-if="filteredContacts.length === 0" class="p-6 text-center">
              <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              <h3 class="text-lg font-semibold text-white mb-2" ng-if="filter === 'all'">No contacts yet</h3>
              <p class="text-gray-400 text-sm leading-relaxed" ng-if="filter === 'all'">You haven't added any contacts yet. Search for people above and add them to start chatting!</p>
              
              <h3 class="text-lg font-semibold text-white mb-2" ng-if="filter === 'archived'">No archived chats</h3>
              <p class="text-gray-400 text-sm leading-relaxed" ng-if="filter === 'archived'">You haven't archived any conversations yet. Archive chats to keep your main list organized.</p>
              
              <h3 class="text-lg font-semibold text-white mb-2" ng-if="filter === 'muted'">No muted chats</h3>
              <p class="text-gray-400 text-sm leading-relaxed" ng-if="filter === 'muted'">You haven't muted any conversations yet. Mute chats to stop receiving notifications from them.</p>
              
              <h3 class="text-lg font-semibold text-white mb-2" ng-if="filter === 'favorites'">No favorites yet</h3>
              <p class="text-gray-400 text-sm leading-relaxed" ng-if="filter === 'favorites'">You haven't added any contacts to favorites yet. Use the heart icon to mark your favorite contacts.</p>
            </div>

            <div class="px-3 py-2">
              <!-- Archived Folder (only show when filter is 'all' and there are archived contacts) -->
              <div 
                ng-if="filter === 'all' && archivedContacts.length > 0"
                ng-click="toggleArchivedFolder()"
                class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 hover:bg-gray-800"
              >
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <!-- Archive folder icon -->
                    <div class="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center">
                      <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <h3 class="text-sm font-semibold text-white">Archived</h3>
                      <p class="text-xs text-gray-400">{{ archivedContacts.length }} {{ archivedContacts.length === 1 ? 'chat' : 'chats' }}</p>
                    </div>
                  </div>
                  <!-- Count badge -->
                  <span class="text-sm font-medium text-gray-400">
                    {{ archivedContacts.length }}
                  </span>
                </div>
              </div>

              <!-- Archived contacts (shown when folder is expanded) -->
              <div ng-if="showArchivedFolder && archivedContacts.length > 0" class="ml-4 mb-2">
                <div
                  ng-repeat="contact in archivedContacts"
                  ng-click="selectContactMobile(contact)"
                  ng-right-click="showContextMenu($event, contact)"
                  ng-class="{ 'hover:bg-gray-800': !selectedContact || selectedContact.email !== contact.email }"
                  ng-style="selectedContact && selectedContact.email === contact.email ? {'background-color': 'rgba(255, 255, 255, 0.1)', 'border-color': 'var(--text-primary)'} : {}"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 group"
                >
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getProfilePicture(contact.profile_picture) }}"
                        auth-image="{{ getProfilePicture(contact.profile_picture) }}"
                        alt="{{ contact.username }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700 transition-all duration-200"
                      >
                      <!-- Online/Idle/Offline status dot -->
                      <div
                        class="absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-gray-900"
                        ng-class="{
                          'bg-green-500': contact.online && !contact.idle,
                          'bg-yellow-500': contact.idle,
                          'bg-gray-500': !contact.online && !contact.idle
                        }"
                      ></div>
                    </div>

                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-white truncate flex items-center space-x-2">
                          <span>{{ contact.name || contact.username }}</span>
                          <!-- Pin icon - push pin (white) -->
                          <svg ng-if="contact.pinned" class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                            <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                          </svg>
                          <!-- Favorite icon - yellow star -->
                          <svg ng-if="contact.is_favorited" class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                            <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                          </svg>
                        </h3>
                        <div class="flex items-center space-x-2">
                          <!-- Unread count badge -->
                          <span 
                            ng-if="contact.unreadCount > 0" 
                            class="unread-badge"
                          >
                            {{ contact.unreadCount > 99 ? '99+' : contact.unreadCount }}
                          </span>
                          <!-- Mute icon - red speaker with X -->
                          <span ng-if="contact.muted" class="text-red-400" title="Muted">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                            </svg>
                          </span>
                          <span class="text-xs text-gray-500" ng-if="contact.lastMessageTime && !contact.isTyping">
                            {{ contact.lastMessageTime | discordTimeCompact }}
                          </span>
                        </div>
                      </div>
                      <!-- Show "Typing..." when user is typing, otherwise show draft or last message -->
                      <p ng-if="contact.isTyping" class="text-xs text-green-500 font-medium contact-message-tight">
                        Typing...
                      </p>
                      <p ng-if="!contact.isTyping && hasDraft(contact)" class="text-xs truncate contact-message-tight">
                        <span class="text-yellow-400 font-medium">Draft:</span>
                        <span class="text-gray-400">{{ getDraftText(contact) }}</span>
                      </p>
                      <p ng-if="!contact.isTyping && !hasDraft(contact)" class="text-xs truncate contact-message-tight" ng-class="contact.lastMessageContent === 'This message was deleted' ? 'text-gray-500 italic' : 'text-gray-400'">
                        {{ contact.lastMessageContent || 'No messages yet' }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Regular contacts (non-archived) -->
              <div
                ng-repeat="contact in filteredContacts"
                ng-click="selectContactMobile(contact)"
                ng-right-click="showContextMenu($event, contact)"
                ng-class="{ 'hover:bg-gray-800': !selectedContact || selectedContact.email !== contact.email }"
                ng-style="selectedContact && selectedContact.email === contact.email ? {'background-color': 'rgba(255, 255, 255, 0.1)', 'border-color': 'var(--text-primary)'} : {}"
                class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 group contact-card-compact"
              >
                <div class="flex items-center space-x-3">
                  <div class="relative">
                    <img
                      ng-src="{{ getProfilePicture(contact.profile_picture) }}"
                      auth-image="{{ getProfilePicture(contact.profile_picture) }}"
                      alt="{{ contact.username }}"
                      class="w-12 h-12 rounded-full ring-2 ring-gray-700 transition-all duration-200"
                    >
                    <!-- Online/Idle/Offline status dot (always visible) -->
                    <div
                      class="absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-gray-900"
                      ng-class="{
                        'bg-green-500': contact.online && !contact.idle,
                        'bg-yellow-500': contact.idle,
                        'bg-gray-500': !contact.online && !contact.idle
                      }"
                    ></div>
                  </div>

                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <h3 class="text-sm font-semibold text-white truncate flex items-center space-x-2" ng-class="{'font-bold': contact.unreadCount > 0}">
                        <span>{{ contact.name || contact.username }}</span>
                        <!-- Pin icon - push pin (white) -->
                        <svg ng-if="contact.pinned" class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                          <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                        </svg>
                        <!-- Favorite icon - yellow star -->
                        <svg ng-if="contact.is_favorited" class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        <!-- Mute icon - red speaker with X -->
                        <svg ng-if="contact.muted" class="w-3.5 h-3.5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Muted">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                        </svg>
                      </h3>
                      <div class="flex flex-col items-end relative">
                        <span class="text-xs text-gray-500" ng-if="contact.lastMessageTime && !contact.isTyping">
                          {{ contact.lastMessageTime | discordTimeCompact }}
                        </span>
                        <!-- Unread count badge - positioned below time exactly where the red dot is -->
                        <span ng-if="contact.unreadCount > 0" class="unread-badge-whatsapp-positioned absolute" style="top: 18px; right: 0;">
                          {{ contact.unreadCount > 99 ? '99+' : contact.unreadCount }}
                        </span>
                      </div>
                    </div>
                    <!-- Show "Typing..." when user is typing, otherwise show draft or last message -->
                    <p ng-if="contact.isTyping" class="text-xs text-green-500 font-medium contact-message-tight">
                      Typing...
                    </p>
                    <p ng-if="!contact.isTyping && hasDraft(contact)" class="text-xs truncate contact-message-tight">
                      <span class="text-yellow-400 font-medium">Draft:</span>
                      <span class="text-gray-400">{{ getDraftText(contact) }}</span>
                    </p>
                    <p ng-if="!contact.isTyping && !hasDraft(contact)" class="text-xs truncate contact-message-tight" ng-class="[
                      contact.lastMessageContent === 'This message was deleted' ? 'text-gray-500 italic' : 'text-gray-400',
                      {'font-bold text-white': contact.isNewMessage}
                    ]">
                      {{ contact.lastMessageContent || 'No messages yet' }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Groups View -->
          <div ng-if="sidebarView === 'groups'">
            <!-- No groups state -->
            <div ng-if="(!groups || groups.length === 0) && (!archivedGroups || archivedGroups.length === 0)" class="flex items-center justify-center h-full p-6">
              <div class="text-center">
                <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-white mb-2">No groups yet</h3>
                <p class="text-gray-400 text-sm leading-relaxed mb-6" ng-if="isEmployee()">Create a new group to start chatting with multiple people.</p>
                <div ng-if="!isEmployee()" class="text-center max-w-md mx-auto mb-6">
                  <p class="text-gray-400 text-sm leading-relaxed mb-3">Want to join a group? Here's how:</p>
                  <div class="bg-gray-800/50 rounded-lg p-4 text-left space-y-2">
                    <div class="flex items-start space-x-2">
                      <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                      </svg>
                      <p class="text-gray-300 text-sm">Enter a <span class="text-blue-400 font-semibold">Group ID</span> in the search bar above</p>
                    </div>
                    <div class="flex items-start space-x-2">
                      <svg class="w-5 h-5 text-green-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                      </svg>
                      <p class="text-gray-300 text-sm">Click an <span class="text-green-400 font-semibold">invite link</span> shared by a member</p>
                    </div>
                  </div>
                </div>
                
                <!-- Create Group Button - Only for employees -->
                <button 
                  ng-if="isEmployee()"
                  ng-click="showCreateGroupModal()"
                  class="py-3 px-6 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 mx-auto"
                  style="background-color: var(--text-primary); color: var(--bg-primary);"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  <span>Create a Group</span>
                </button>
              </div>
            </div>
            
            <!-- Groups list (when user has groups) -->
            <div ng-if="(groups && groups.length > 0) || (archivedGroups && archivedGroups.length > 0)" class="flex-1 overflow-y-auto scrollbar-thin">
              <!-- Empty state for filtered groups -->
              <div ng-if="filteredGroups.length === 0 && groupFilter !== 'all'" class="p-6 text-center">
                <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                
                <h3 class="text-lg font-semibold text-white mb-2" ng-if="groupFilter === 'muted'">No muted groups</h3>
                <p class="text-gray-400 text-sm leading-relaxed" ng-if="groupFilter === 'muted'">You haven't muted any groups yet. Mute groups to stop receiving notifications from them.</p>
                
                <h3 class="text-lg font-semibold text-white mb-2" ng-if="groupFilter === 'favorites'">No favorites yet</h3>
                <p class="text-gray-400 text-sm leading-relaxed" ng-if="groupFilter === 'favorites'">You haven't added any groups to favorites yet. Use the star icon to mark your favorite groups.</p>
              </div>

              <div class="px-3 py-2">
                <!-- Archived Groups Folder (only show when filter is 'all' and there are archived groups) -->
                <div 
                  ng-if="groupFilter === 'all' && archivedGroups.length > 0"
                  ng-click="toggleArchivedFolder()"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 hover:bg-gray-800"
                >
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                      <!-- Archive folder icon -->
                      <div class="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                      </div>
                      <div class="flex-1">
                        <h3 class="text-sm font-semibold text-white">Archived</h3>
                        <p class="text-xs text-gray-400">{{ archivedGroups.length }} {{ archivedGroups.length === 1 ? 'group' : 'groups' }}</p>
                      </div>
                    </div>
                    <!-- Count badge -->
                    <span class="text-sm font-medium text-gray-400">
                      {{ archivedGroups.length }}
                    </span>
                  </div>
                </div>

                <!-- Archived groups (shown when folder is expanded) -->
                <div ng-if="showArchivedFolder && archivedGroups.length > 0" class="mb-2">
                  <div
                    ng-repeat="group in archivedGroups"
                    ng-click="selectGroupMobile(group)"
                    ng-right-click="showContextMenu($event, group)"
                    ng-class="{ 'hover:bg-gray-800': !selectedContact || selectedContact.conversation_id !== group.conversation_id }"
                    ng-style="selectedContact && selectedContact.conversation_id === group.conversation_id ? {'background-color': 'rgba(255, 255, 255, 0.1)', 'border-color': 'var(--text-primary)'} : {}"
                    class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 group"
                  >
                    <div class="flex items-center space-x-3">
                      <div class="relative">
                        <img
                          ng-src="{{ getGroupPicture(group) }}"
                          alt="{{ group.name }}"
                          class="w-12 h-12 rounded-full ring-2 ring-gray-700 transition-all duration-200"
                        >
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                          <h3 class="text-sm font-semibold text-white truncate flex items-center space-x-2">
                            <span>{{ group.name }}</span>
                            <!-- Pin icon -->
                            <svg ng-if="group.pinned" class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                              <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                            </svg>
                            <!-- Favorite icon -->
                            <svg ng-if="group.is_favorited" class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                              <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                          </h3>
                          <div class="flex items-center space-x-2">
                            <!-- Unread count badge -->
                            <span 
                              ng-if="group.unreadCount > 0" 
                              class="unread-badge"
                            >
                              {{ group.unreadCount > 99 ? '99+' : group.unreadCount }}
                            </span>
                            <!-- Mute icon -->
                            <span ng-if="group.muted" class="text-red-400" title="Muted">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                              </svg>
                            </span>
                            <span class="text-xs text-gray-500" ng-if="group.lastMessageTime">
                              {{ group.lastMessageTime | discordTimeCompact }}
                            </span>
                          </div>
                        </div>
                        <p ng-if="hasDraft(group)" class="text-xs truncate contact-message-tight">
                          <span class="text-yellow-400 font-medium">Draft:</span>
                          <span class="text-gray-400">{{ getDraftText(group) }}</span>
                        </p>
                        <p ng-if="!hasDraft(group)" class="text-xs truncate contact-message-tight" ng-class="group.lastMessageContent === 'This message was deleted' ? 'text-gray-500 italic' : 'text-gray-400'">
                          {{ group.lastMessageContent || 'No messages yet' }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Regular groups (non-archived, filtered) -->
                <div
                  ng-repeat="group in filteredGroups"
                  ng-click="selectGroupMobile(group)"
                  ng-right-click="showContextMenu($event, group)"
                  ng-class="{ 'hover:bg-gray-800': !selectedContact || selectedContact.conversation_id !== group.conversation_id }"
                  ng-style="selectedContact && selectedContact.conversation_id === group.conversation_id ? {'background-color': 'rgba(255, 255, 255, 0.1)', 'border-color': 'var(--text-primary)'} : {}"
                  class="p-4 rounded-xl cursor-pointer transition-all duration-200 border border-transparent mb-2 group contact-card-compact"
                >
                  <div class="flex items-center space-x-3">
                    <div class="relative">
                      <img
                        ng-src="{{ getGroupPicture(group) }}"
                        alt="{{ group.name }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700 transition-all duration-200"
                      >
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-white truncate flex items-center space-x-2">
                          <span>{{ group.name }}</span>
                          <!-- Pin icon -->
                          <svg ng-if="group.pinned" class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                            <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                          </svg>
                          <!-- Favorite icon -->
                          <svg ng-if="group.is_favorited" class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                            <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                          </svg>
                        </h3>
                        <div class="flex items-center space-x-2">
                          <!-- Unread count badge -->
                          <span 
                            ng-if="group.unreadCount > 0" 
                            class="unread-badge"
                          >
                            {{ group.unreadCount > 99 ? '99+' : group.unreadCount }}
                          </span>
                          <!-- Mute icon -->
                          <span ng-if="group.muted" class="text-red-400" title="Muted">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                            </svg>
                          </span>
                          <span class="text-xs text-gray-500" ng-if="group.lastMessageTime">
                            {{ group.lastMessageTime | discordTimeCompact }}
                          </span>
                        </div>
                      </div>
                      <p ng-if="hasDraft(group)" class="text-xs truncate contact-message-tight">
                        <span class="text-yellow-400 font-medium">Draft:</span>
                        <span class="text-gray-400">{{ getDraftText(group) }}</span>
                      </p>
                      <p ng-if="!hasDraft(group)" class="text-xs truncate contact-message-tight" ng-class="group.lastMessageContent === 'This message was deleted' ? 'text-gray-500 italic' : 'text-gray-400'">
                        {{ group.lastMessageContent || 'No messages yet' }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Floating Add Button (when user has groups) - Only for employees -->
            <div ng-if="isEmployee() && ((groups && groups.length > 0) || (archivedGroups && archivedGroups.length > 0))" class="absolute bottom-4 right-4 z-20">
              <button 
                ng-click="showGroupActionsModal()"
                class="w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-110"
                style="background-color: var(--text-primary); color: var(--bg-primary);"
                title="Create or Join Group"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Settings View -->
          <div ng-if="sidebarView === 'settings'" class="p-6">
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                App Settings
              </h3>
              
              <!-- Theme Setting -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Theme</label>
                <div class="relative">
                  <div class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between opacity-75 cursor-not-allowed" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                    <div class="flex items-center">
                      <!-- Dark theme icon -->
                      <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                      </svg>
                      <span>Dark</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15l3-3H9l3 3z"></path>
                    </svg>
                  </div>
                  
                  <!-- Development Notice -->
                  <div class="mt-2 text-xs text-gray-400 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Light theme is currently in development
                  </div>
                </div>
              </div>
              
              <!-- Group Chat Backup Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                  </svg>
                  Group Chat Backup
                </h4>
                
                <!-- Export Group Chat -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Export Group Chat</label>
                  <div class="relative">
                    <button
                      ng-click="toggleBackupDropdown(); $event.stopPropagation()"
                      ng-disabled="getAdminGroups().length === 0"
                      class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                      style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                    >
                      <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span ng-if="getAdminGroups().length > 0">Select group to export</span>
                        <span ng-if="getAdminGroups().length === 0" class="text-gray-500">No groups available for export</span>
                      </div>
                      <svg ng-if="getAdminGroups().length > 0" class="w-4 h-4 text-gray-400 transition-transform duration-200" ng-class="{'rotate-180': backupDropdownOpen}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                    
                    <!-- Export Dropdown -->
                    <div ng-if="backupDropdownOpen && getAdminGroups().length > 0" ng-click="$event.stopPropagation()" class="absolute top-full left-0 right-0 mt-1 rounded-lg border shadow-lg z-20 max-h-48 overflow-y-auto" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                      <div 
                        ng-repeat="group in getAdminGroups()"
                        ng-click="exportGroupChat(group)"
                        class="px-4 py-3 hover:bg-gray-700 cursor-pointer transition-colors duration-200 flex items-center"
                        ng-class="{'opacity-50 cursor-not-allowed': exportingGroup && selectedGroupForBackup.id !== group.id}"
                      >
                        <img
                          ng-src="{{ getGroupPicture(group) }}"
                          alt="{{ group.name }}"
                          class="w-8 h-8 rounded-full mr-3 flex-shrink-0"
                        >
                        <div class="flex-1 min-w-0">
                          <div class="text-white font-medium truncate">{{ group.name }}</div>
                          <div class="text-xs text-gray-400">{{ group.members_count }} members</div>
                        </div>
                        <div ng-if="exportingGroup && selectedGroupForBackup.id === group.id" class="ml-2">
                          <div class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
                        </div>
                        <svg ng-if="group.owner === currentUser.email" class="w-4 h-4 text-yellow-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Owner">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z"></path>
                        </svg>
                        <svg ng-if="group.owner !== currentUser.email" class="w-4 h-4 text-blue-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Admin">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 text-xs text-gray-500">
                    Only group owners and admins can export chat history
                  </div>
                </div>
                
                <!-- Import Group Chat -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Import Group Chat</label>
                  <button
                    ng-click="triggerImportFile()"
                    ng-disabled="importingGroup"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-center focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <svg ng-if="!importingGroup" class="w-4 h-4 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <div ng-if="importingGroup" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full mr-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
                    <span ng-if="!importingGroup">Choose CSV file to import</span>
                    <span ng-if="importingGroup">Importing...</span>
                  </button>
                  
                  <!-- Hidden file input -->
                  <input 
                    type="file" 
                    id="importCsvFile" 
                    accept=".csv,text/csv" 
                    style="display: none;" 
                    onchange="angular.element(this).scope().onImportFileSelected(event)"
                  >
                  
                  <div class="mt-2 text-xs text-gray-500">
                    Upload a CSV file containing chat history to import
                  </div>
                </div>
              </div>
              
              <!-- Notification Audio Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M8.464 8.464a5 5 0 000 7.072M5.636 5.636a9 9 0 000 12.728M12 12h.01"></path>
                  </svg>
                  Notifications & Sounds
                </h4>
                
                <!-- Browser Notifications -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Browser Notifications</label>
                  <button
                    ng-click="checkAndRequestNotificationPermission()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.868 19.718A10.968 10.968 0 016.75 19h2.5A10.968 10.968 0 0112 20.25c1.357 0 2.637-.247 3.868-.682M4.868 19.718A10.968 10.968 0 013 12c0-1.357.247-2.637.682-3.868M4.868 19.718L12 12.75l7.132 6.968M20.25 12c0 1.357-.247 2.637-.682 3.868M20.25 12L12 4.25 3.75 12"></path>
                      </svg>
                      <span>Enable Browser Notifications</span>
                    </div>
                    <div class="flex items-center">
                      <div 
                        ng-if="notificationPermission === 'granted'"
                        class="w-2 h-2 bg-green-500 rounded-full mr-2"
                      ></div>
                      <div 
                        ng-if="notificationPermission === 'denied'"
                        class="w-2 h-2 bg-red-500 rounded-full mr-2"
                      ></div>
                      <div 
                        ng-if="notificationPermission === 'default'"
                        class="w-2 h-2 bg-yellow-500 rounded-full mr-2"
                      ></div>
                      <span class="text-xs text-gray-400">
                        {{ notificationPermission === 'granted' ? 'Enabled' : 
                           notificationPermission === 'denied' ? 'Blocked' : 'Not Set' }}
                      </span>
                    </div>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    <span ng-if="notificationPermission === 'granted'"> You'll receive desktop notifications for new messages</span>
                    <span ng-if="notificationPermission === 'denied'"> Notifications are blocked. Enable them in your browser settings.</span>
                    <span ng-if="notificationPermission === 'default'"> Click to enable desktop notifications for new messages</span>
                  </div>
                </div>
                
                <!-- Enable Audio Button -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Audio Notifications</label>
                  <button
                    ng-click="enableAudioWithUserInteraction()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-center focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <svg class="w-4 h-4 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M8.464 8.464a5 5 0 000 7.072M5.636 5.636a9 9 0 000 12.728M12 12h.01"></path>
                    </svg>
                    <span>Enable Notification Sounds</span>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    Click to enable audio notifications (required by browser security)
                  </div>
                </div>
              </div>
              
              <!-- Privacy & Safety Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                  Privacy & Safety
                </h4>
                
                <!-- Blocked Users Button -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Blocked Users</label>
                  <button
                    ng-click="openBlockedUsersModal()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                      </svg>
                      <span>Manage Blocked Users</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    View and manage users you have blocked
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Message Confirmation Modal -->
    <div ng-if="deleteConfirmation.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="cancelDeleteMessage()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">Delete Message?</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Are you sure you want to delete this message? This action cannot be undone and the other person will be notified that you deleted a message.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelDeleteMessage()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmDeleteMessage()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Delete Message
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Chat Confirmation Modal -->
    <div ng-if="deleteChatConfirmation.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="cancelDeleteChat()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3" ng-if="!deleteChatConfirmation.contact.isGroup">Delete Chat?</h3>
          <h3 class="text-xl font-bold text-white mb-3" ng-if="deleteChatConfirmation.contact.isGroup">Delete Group?</h3>
          <p class="text-gray-400 text-sm leading-relaxed" ng-if="!deleteChatConfirmation.contact.isGroup">
            Are you sure you want to delete the chat with <span class="text-white font-medium">{{ deleteChatConfirmation.contact.name || deleteChatConfirmation.contact.username }}</span>? 
            All messages will be permanently deleted and this action cannot be undone.
          </p>
          <p class="text-gray-400 text-sm leading-relaxed" ng-if="deleteChatConfirmation.contact.isGroup">
            Are you sure you want to delete the group <span class="text-white font-medium">{{ deleteChatConfirmation.contact.name }}</span>? 
            All messages will be permanently deleted and this action cannot be undone.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelDeleteChat()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmDeleteChat()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            <span ng-if="!deleteChatConfirmation.contact.isGroup">Delete Chat</span>
            <span ng-if="deleteChatConfirmation.contact.isGroup">Delete Group</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Remove Contact Confirmation Modal -->
    <div ng-if="removeContactConfirmation.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="cancelRemoveContact()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">Remove Contact?</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Are you sure you want to remove <span class="text-white font-medium">{{ removeContactConfirmation.contact.name || removeContactConfirmation.contact.username }}</span> from your contacts? 
            You can still add them back by searching, your chat history wont be deleted.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelRemoveContact()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmRemoveContact()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Remove Contact
          </button>
        </div>
      </div>
    </div>

    <!-- Leave Group Confirmation Modal -->
    <div ng-if="leaveGroupConfirmation.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="cancelLeaveGroup()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">Leave Group?</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Are you sure you want to leave <span class="text-white font-medium">{{ leaveGroupConfirmation.group.name }}</span>? 
            You will no longer receive messages from this group and will need to be re-invited to join again.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelLeaveGroup()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmLeaveGroup()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Leave Group
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Role Confirmation Modal -->
    <div ng-if="deleteRoleConfirmation.show" class="fixed inset-0 flex items-center justify-center confirmation-modal" style="z-index: 60;">
      <!-- Backdrop -->
      <div 
        ng-click="cancelDeleteRole()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">Delete Role?</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Are you sure you want to delete the role <span class="text-white font-medium">"{{ deleteRoleConfirmation.roleName }}"</span>? 
            This action cannot be undone and all members will lose this role.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelDeleteRole()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmDeleteRole()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Delete Role
          </button>
        </div>
      </div>
    </div>

    <!-- Remove Member Confirmation Modal -->
    <div ng-if="removeMemberConfirmation.show" class="fixed inset-0 flex items-center justify-center confirmation-modal" style="z-index: 60;">
      <!-- Backdrop -->
      <div 
        ng-click="cancelRemoveMember()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">Remove Member?</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Are you sure you want to remove <span class="text-white font-medium">{{ removeMemberConfirmation.memberName }}</span> from the group? 
            They will no longer have access to this group and will need to be re-invited to join again.
          </p>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3">
          <button 
            ng-click="cancelRemoveMember()"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Cancel
          </button>
          <button 
            ng-click="confirmRemoveMember()"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Remove Member
          </button>
        </div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div ng-if="createGroupModal.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="cancelCreateGroup()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border w-full max-w-2xl mx-4 fade-in overflow-hidden" style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 90vh;">
        <!-- Header -->
        <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: var(--text-primary);">
                <svg class="w-6 h-6" style="color: var(--bg-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Create a New Group</h2>
                <p class="text-xs text-gray-400">Start a group conversation with your contacts</p>
              </div>
            </div>
            <button 
              ng-click="cancelCreateGroup()"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
          <!-- Group Name Input -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-300 mb-2">Group Name *</label>
            <input
              type="text"
              ng-model="createGroupModal.groupName"
              placeholder="Enter group name..."
              class="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
              style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
              maxlength="50"
            >
            <p class="text-xs text-gray-500 mt-1">{{ createGroupModal.groupName.length }}/50 characters</p>
          </div>

          <!-- Select Members -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              Select Members * 
              <span class="text-gray-500">({{ createGroupModal.selectedMembers.length }} selected)</span>
            </label>
            
            <!-- Search Members -->
            <div class="mb-3">
              <input
                type="text"
                ng-model="createGroupModal.memberSearch"
                placeholder="Search contacts..."
                class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
                style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
              >
            </div>
            
            <!-- Members List -->
            <div class="border rounded-lg overflow-hidden" style="border-color: var(--border-color); max-height: 300px; overflow-y: auto;">
              <div ng-if="contacts.length === 0" class="p-6 text-center text-gray-400">
                <p>No contacts available. Add contacts first to create a group.</p>
              </div>
              
              <div ng-if="getFilteredContactsForGroup().length === 0 && contacts.length > 0" class="p-6 text-center text-gray-400">
                <p>No contacts found matching "{{ createGroupModal.memberSearch }}"</p>
              </div>
              
              <div 
                ng-repeat="contact in getFilteredContactsForGroup()" 
                class="flex items-center justify-between p-3 border-b hover:bg-gray-800/30 transition-colors"
                style="border-color: var(--border-color);"
                ng-class="{'bg-gray-800/50': isContactSelected(contact.email)}"
              >
                <div class="flex items-center gap-3 flex-1 min-w-0">
                  <img
                    ng-src="{{ getProfilePicture(contact.profile_picture) }}"
                    auth-image="{{ getProfilePicture(contact.profile_picture) }}"
                    alt="{{ contact.username }}"
                    class="w-10 h-10 rounded-full flex-shrink-0"
                  >
                  <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-semibold text-white truncate">
                      {{ contact.name || contact.username }}
                    </h3>
                    <p class="text-xs text-gray-400 truncate">
                      @{{ contact.username }}
                    </p>
                  </div>
                </div>
                
                <button
                  ng-click="toggleMemberSelection(contact.email)"
                  class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200"
                  ng-class="isContactSelected(contact.email) ? 'bg-white text-black' : 'bg-yellow-500 text-black hover:bg-yellow-400'"
                >
                  {{ isContactSelected(contact.email) ? 'Unselect' : 'Select' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t" style="border-color: var(--border-color); background-color: var(--bg-tertiary);">
          <!-- Info Message -->
          <div class="mb-4 p-3 rounded-lg bg-blue-500/10 border border-blue-500/30">
            <div class="flex gap-2">
              <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-xs text-blue-300 leading-relaxed">
                <strong>Tip:</strong> After creating the group, you can copy the Group ID and share it with others to invite them, or add members directly from your contacts.
              </p>
            </div>
          </div>

          <!-- Buttons -->
          <div class="flex gap-3">
            <button 
              ng-click="cancelCreateGroup()"
              class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium"
            >
              Cancel
            </button>
            <button 
              ng-click="confirmCreateGroup()"
              ng-disabled="!createGroupModal.groupName.trim() || createGroupModal.selectedMembers.length === 0 || createGroupModal.creating"
              class="flex-1 py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
              style="background-color: var(--text-primary); color: var(--bg-primary);"
            >
              <span ng-if="!createGroupModal.creating">Create Group</span>
              <span ng-if="createGroupModal.creating" class="flex items-center justify-center gap-2">
                <span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                Creating...
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Info Modal -->
    <div ng-if="contactInfoModal.show" class="fixed inset-0 flex items-center justify-center" style="z-index: 50;">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-70" ng-click="closeContactInfo()"></div>
      
      <!-- Modal Content -->
      <div class="relative rounded-xl shadow-2xl max-w-md w-full mx-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 90vh; overflow-y: auto;">
        <!-- Header -->
        <div class="p-6 border-b" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-white">Contact Info</h3>
            <button ng-click="closeContactInfo()" class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Contact Profile Section -->
        <div class="p-6 text-center">
          <div class="relative inline-block mb-4">
            <img 
              ng-src="{{ getProfilePicture(contactInfoModal.contact.profile_picture) }}"
              auth-image="{{ getProfilePicture(contactInfoModal.contact.profile_picture) }}"
              alt="{{ contactInfoModal.contact.name }}"
              class="w-24 h-24 rounded-full mx-auto ring-4"
              style="--tw-ring-color: var(--text-primary);"
            />
            <!-- Status dot -->
            <div
              class="absolute bottom-1 right-1 w-6 h-6 rounded-full border-4"
              style="border-color: var(--bg-secondary);"
              ng-class="{
                'bg-green-500': contactInfoModal.contact.online && !contactInfoModal.contact.idle,
                'bg-yellow-500': contactInfoModal.contact.idle,
                'bg-gray-500': !contactInfoModal.contact.online && !contactInfoModal.contact.idle
              }"
            ></div>
          </div>
          
          <h2 class="text-2xl font-bold text-white mb-1">{{ contactInfoModal.contact.name }}</h2>
          <p class="text-gray-400 mb-3">@{{ contactInfoModal.contact.username }}</p>
          
          <!-- Status -->
          <div class="inline-flex items-center space-x-2 px-3 py-1 rounded-full text-sm mb-6" style="background-color: var(--bg-primary);">
            <div 
              class="w-2 h-2 rounded-full"
              ng-class="{
                'bg-green-500': contactInfoModal.contact.online && !contactInfoModal.contact.idle,
                'bg-yellow-500': contactInfoModal.contact.idle,
                'bg-gray-500': !contactInfoModal.contact.online && !contactInfoModal.contact.idle
              }"
            ></div>
            <span class="text-gray-300">
              <span ng-if="contactInfoModal.contact.online && !contactInfoModal.contact.idle">Online</span>
              <span ng-if="contactInfoModal.contact.idle">Idling</span>
              <span ng-if="!contactInfoModal.contact.online && !contactInfoModal.contact.idle && contactInfoModal.contact.last_seen">Last seen {{ contactInfoModal.contact.last_seen | discordTime }}</span>
              <span ng-if="!contactInfoModal.contact.online && !contactInfoModal.contact.idle && !contactInfoModal.contact.last_seen">Offline</span>
            </span>
          </div>

          <!-- Contact Since -->
          <div ng-if="contactInfoModal.contact.added_at" class="mb-6">
            <label class="block text-sm font-medium text-gray-400 mb-2">Contact Since</label>
            <div class="px-4 py-2 rounded-lg text-white" style="background-color: var(--bg-primary);">
              {{ contactInfoModal.contact.added_at | date:'medium' }}
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button
              ng-click="confirmBlockContact(contactInfoModal.contact)"
              class="w-full px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2 bg-orange-600 hover:bg-orange-700 text-white"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
              </svg>
              <span>Block Contact</span>
            </button>

            <button
              ng-click="showRemoveContactConfirmation(contactInfoModal.contact)"
              class="w-full px-4 py-3 rounded-lg font-medium transition-colors bg-red-600 hover:bg-red-700 text-white flex items-center justify-center space-x-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
              </svg>
              <span>Remove Contact</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Block Contact Confirmation Modal -->
    <div ng-if="blockContactConfirmation.show" class="fixed inset-0 flex items-center justify-center" style="z-index: 60;">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-70" ng-click="cancelBlockContact()"></div>
      
      <!-- Modal Content -->
      <div class="relative rounded-xl shadow-2xl max-w-md w-full mx-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Header -->
        <div class="p-6 border-b" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-white">Block Contact</h3>
            <button ng-click="cancelBlockContact()" class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="p-6">
          <div class="flex items-center space-x-4 mb-4">
            <img 
              ng-src="{{ getProfilePicture(blockContactConfirmation.contact.profile_picture) }}"
              auth-image="{{ getProfilePicture(blockContactConfirmation.contact.profile_picture) }}"
              alt="{{ blockContactConfirmation.contact.name }}"
              class="w-16 h-16 rounded-full"
            />
            <div>
              <h4 class="text-lg font-semibold text-white">{{ blockContactConfirmation.contact.name }}</h4>
              <p class="text-sm text-gray-400">@{{ blockContactConfirmation.contact.username }}</p>
            </div>
          </div>
          
          <p class="text-gray-300 mb-3">Are you sure you want to block <strong class="text-white">{{ blockContactConfirmation.contact.name }}</strong>?</p>
          <p class="text-sm text-gray-400 mb-2">Blocking will prevent them from:</p>
          <ul class="text-sm text-gray-400 list-disc list-inside space-y-1 mb-4">
            <li>Sending you messages</li>
            <li>Seeing your online status</li>
            <li>Adding you to groups</li>
          </ul>
          <p class="text-sm text-yellow-400"> Tip: You can archive the chat instead to hide it without blocking.</p>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t flex items-center justify-end space-x-3" style="border-color: var(--border-color);">
          <button
            ng-click="archiveInsteadOfBlock()"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-700 hover:bg-gray-600 text-white"
          >
            Archive Instead
          </button>
          <button
            ng-click="executeBlockContact()"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-orange-600 hover:bg-orange-700 text-white"
          >
            Block Anyway
          </button>
        </div>
      </div>
    </div>

    <!-- Remove Contact Confirmation Modal -->
    <div ng-if="removeContactConfirmation.show" class="fixed inset-0 flex items-center justify-center" style="z-index: 60;">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-70" ng-click="cancelRemoveContact()"></div>
      
      <!-- Modal Content -->
      <div class="relative rounded-xl shadow-2xl max-w-md w-full mx-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Header -->
        <div class="p-6 border-b" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-white">Remove Contact</h3>
            <button ng-click="cancelRemoveContact()" class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="p-6">
          <div class="flex items-center space-x-4 mb-4">
            <img 
              ng-src="{{ getProfilePicture(removeContactConfirmation.contact.profile_picture) }}"
              auth-image="{{ getProfilePicture(removeContactConfirmation.contact.profile_picture) }}"
              alt="{{ removeContactConfirmation.contact.name }}"
              class="w-16 h-16 rounded-full"
            />
            <div>
              <h4 class="text-lg font-semibold text-white">{{ removeContactConfirmation.contact.name }}</h4>
              <p class="text-sm text-gray-400">@{{ removeContactConfirmation.contact.username }}</p>
            </div>
          </div>
          
          <p class="text-gray-300 mb-2">Are you sure you want to remove <strong class="text-white">{{ removeContactConfirmation.contact.name }}</strong> from your contacts?</p>
          <p class="text-sm text-gray-400">This will:</p>
          <ul class="text-sm text-gray-400 list-disc list-inside space-y-1 mt-2">
            <li>Remove them from your contact list</li>
            <li>Close the current chat</li>
            <li>Require adding them back to chat again</li>
          </ul>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t flex items-center justify-end space-x-3" style="border-color: var(--border-color);">
          <button
            ng-click="cancelRemoveContact()"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-700 hover:bg-gray-600 text-white"
          >
            Cancel
          </button>
          <button
            ng-click="executeRemoveContact()"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-red-600 hover:bg-red-700 text-white"
          >
            Remove Contact
          </button>
        </div>
      </div>
    </div>

    <!-- Forward Message Modal -->
    <div ng-if="forwardModal.show" class="fixed inset-0 flex items-center justify-center" style="z-index: 60;">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm" ng-click="closeForwardModal()"></div>
      
      <!-- Modal Content -->
      <div class="relative rounded-xl shadow-2xl max-w-md w-full mx-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 80vh;">
        <!-- Header -->
        <div class="p-6 border-b" style="border-color: var(--border-color);">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-white">Forward Message</h3>
            <button ng-click="closeForwardModal()" class="text-gray-400 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Search Bar -->
        <div class="p-4 border-b" style="border-color: var(--border-color);">
          <div class="relative">
            <input
              type="text"
              ng-model="forwardModal.searchQuery"
              ng-change="onForwardSearchChange()"
              placeholder="Search chats and groups..."
              class="w-full border rounded-lg px-4 py-2 pl-10 placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
              style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
            >
            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>

        <!-- Tabs -->
        <div class="px-4 pt-4">
          <div class="flex space-x-1 rounded-lg p-1 relative overflow-hidden" style="background-color: #000000;">
            <!-- Animated background -->
            <div 
              class="absolute top-1 bottom-1 rounded-md transition-all duration-300 ease-in-out"
              style="background-color: var(--text-primary);"
              ng-style="{
                'left': forwardModal.activeTab === 'chats' ? '4px' : 'calc(50% + 2px)',
                'width': 'calc(50% - 4px)'
              }"
            ></div>
            
            <button
              ng-click="setForwardTab('chats')"
              ng-class="{ 'text-gray-400 hover:text-white': forwardModal.activeTab !== 'chats' }"
              ng-style="forwardModal.activeTab === 'chats' ? {'color': 'var(--bg-primary)'} : {}"
              class="flex-1 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
            >
              Chats
            </button>
            <button
              ng-click="setForwardTab('groups')"
              ng-class="{ 'text-gray-400 hover:text-white': forwardModal.activeTab !== 'groups' }"
              ng-style="forwardModal.activeTab === 'groups' ? {'color': 'var(--bg-primary)'} : {}"
              class="flex-1 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
            >
              Groups
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="p-4 overflow-y-auto" style="max-height: 400px;">
          <!-- Chats Tab -->
          <div ng-if="forwardModal.activeTab === 'chats'">
            <!-- Chat List -->
            <div ng-if="forwardModal.filteredChats && forwardModal.filteredChats.length > 0" class="space-y-2">
              <div
                ng-repeat="contact in forwardModal.filteredChats"
                ng-click="forwardToContact(contact)"
                class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-800/50 border border-transparent hover:border-gray-700"
              >
                <div class="flex items-center space-x-3">
                  <div class="relative">
                    <img
                      ng-src="{{ getProfilePicture(contact.profile_picture) }}"
                      auth-image="{{ getProfilePicture(contact.profile_picture) }}"
                      alt="{{ contact.username }}"
                      class="w-10 h-10 rounded-full ring-2 ring-gray-700"
                    >
                    <div
                      class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-gray-900"
                      ng-class="{
                        'bg-green-500': contact.online && !contact.idle,
                        'bg-yellow-500': contact.idle,
                        'bg-gray-500': !contact.online && !contact.idle
                      }"
                    ></div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-semibold text-white truncate">
                      {{ contact.name || contact.username }}
                    </h4>
                    <p class="text-xs text-gray-400 truncate">
                      @{{ contact.username }}
                    </p>
                  </div>
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>
            </div>
            
            <!-- No chats message -->
            <div ng-if="!forwardModal.filteredChats || forwardModal.filteredChats.length === 0" class="text-center py-12 forward-empty-state">
              <div class="mb-4">
                <svg class="w-16 h-16 text-gray-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-white mb-2">No chats available</h4>
              <p class="text-gray-400 text-sm leading-relaxed max-w-xs mx-auto">
                <span ng-if="!forwardModal.searchQuery">You don't have any contacts yet. Add some contacts to start forwarding messages!</span>
                <span ng-if="forwardModal.searchQuery">No contacts match your search. Try a different search term.</span>
              </p>
              <div ng-if="!forwardModal.searchQuery" class="mt-4">
                <button 
                  ng-click="closeForwardModal(); setSidebarView('chats')"
                  class="inline-flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200"
                  style="background-color: var(--text-primary); color: var(--bg-primary);"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span>Find Contacts</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Groups Tab -->
          <div ng-if="forwardModal.activeTab === 'groups'">
            <!-- Group List -->
            <div ng-if="forwardModal.filteredGroups && forwardModal.filteredGroups.length > 0" class="space-y-2">
              <div
                ng-repeat="group in forwardModal.filteredGroups"
                ng-click="forwardToGroup(group)"
                class="p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-800/50 border border-transparent hover:border-gray-700"
              >
                <div class="flex items-center space-x-3">
                  <img
                    ng-src="{{ getGroupPicture(group) }}"
                    alt="{{ group.name }}"
                    class="w-10 h-10 rounded-full ring-2 ring-gray-700"
                  >
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-semibold text-white truncate">
                      {{ group.name }}
                    </h4>
                    <p class="text-xs text-gray-400 truncate">
                      {{ group.members_count || (group.participants && group.participants.length) || 0 }} member{{ (group.members_count || (group.participants && group.participants.length) || 0) !== 1 ? 's' : '' }}
                    </p>
                  </div>
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>
            </div>
            
            <!-- No groups message -->
            <div ng-if="!forwardModal.filteredGroups || forwardModal.filteredGroups.length === 0" class="text-center py-12 forward-empty-state">
              <div class="mb-4">
                <svg class="w-16 h-16 text-gray-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-white mb-2">No groups available</h4>
              <p class="text-gray-400 text-sm leading-relaxed max-w-xs mx-auto">
                <span ng-if="!forwardModal.searchQuery">You haven't joined any groups yet. Create or join a group to start forwarding messages!</span>
                <span ng-if="forwardModal.searchQuery">No groups match your search. Try a different search term.</span>
              </p>
              <div ng-if="!forwardModal.searchQuery" class="mt-4">
                <button 
                  ng-click="closeForwardModal(); setSidebarView('groups')"
                  class="inline-flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200"
                  style="background-color: var(--text-primary); color: var(--bg-primary);"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  <span>Explore Groups</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t text-center" style="border-color: var(--border-color);">
          <p class="text-xs text-gray-400">
            Select a chat or group to forward the message
          </p>
        </div>
      </div>
    </div>

    <!-- Group Settings Modal -->
    <div ng-if="groupSettingsModal.show" class="fixed inset-0 flex items-center justify-center group-settings-modal" style="z-index: 50;">
      <!-- Backdrop -->
      <div 
        ng-click="closeGroupSettings()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border w-full max-w-4xl mx-4 fade-in overflow-hidden" style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 90vh;">
        <!-- Header -->
        <div class="px-6 py-4 border-b flex items-center justify-between" style="border-color: var(--border-color);">
          <h2 class="text-xl font-bold text-white">Group Settings</h2>
          <button 
            ng-click="closeGroupSettings()"
            class="text-gray-400 hover:text-white transition-colors"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Tabs -->
        <div class="px-6 py-3 border-b flex space-x-4" style="border-color: var(--border-color);">
          <button
            ng-click="groupSettingsModal.activeTab = 'overview'"
            ng-class="groupSettingsModal.activeTab === 'overview' ? 'text-white border-b-2' : 'text-gray-400 hover:text-white'"
            class="pb-2 px-2 font-medium transition-colors"
            ng-style="groupSettingsModal.activeTab === 'overview' ? {'border-color': 'var(--text-primary)'} : {}"
          >
            Overview
          </button>
          <button
            ng-click="groupSettingsModal.activeTab = 'members'"
            ng-class="groupSettingsModal.activeTab === 'members' ? 'text-white border-b-2' : 'text-gray-400 hover:text-white'"
            class="pb-2 px-2 font-medium transition-colors"
            ng-style="groupSettingsModal.activeTab === 'members' ? {'border-color': 'var(--text-primary)'} : {}"
          >
            Members
          </button>
          <button
            ng-if="!isImportedGroup(groupSettingsModal.group)"
            ng-click="groupSettingsModal.activeTab = 'roles'"
            ng-class="groupSettingsModal.activeTab === 'roles' ? 'text-white border-b-2' : 'text-gray-400 hover:text-white'"
            class="pb-2 px-2 font-medium transition-colors"
            ng-style="groupSettingsModal.activeTab === 'roles' ? {'border-color': 'var(--text-primary)'} : {}"
          >
            Roles
          </button>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto group-settings-scrollable" style="max-height: calc(90vh - 200px);">
          <!-- Overview Tab -->
          <div ng-if="groupSettingsModal.activeTab === 'overview'">
            <!-- Imported Group Notice -->
            <div ng-if="isImportedGroup(groupSettingsModal.group)" class="mb-6 p-4 rounded-lg border" style="background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3);">
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-yellow-400">Imported Group</h4>
                  <p class="text-xs text-yellow-300 mt-1">This group was imported from a backup. You cannot modify settings, add members, or create roles for imported groups.</p>
                </div>
              </div>
            </div>
            
            <!-- Group Picture -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-300 mb-3">Group Picture</label>
              <div class="flex items-center space-x-4">
                <img
                  ng-src="{{ isImportedGroup(groupSettingsModal.group) ? getGroupPicture(groupSettingsModal.group) : groupSettingsModal.picturePreview }}"
                  alt="Group"
                  class="w-24 h-24 rounded-full ring-2 ring-gray-700"
                >
                <div ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)">
                  <input
                    type="file"
                    id="groupPictureInput"
                    accept="image/*"
                    class="hidden"
                    onchange="angular.element(this).scope().onGroupPictureSelect(this.files)"
                  >
                  <button
                    onclick="document.getElementById('groupPictureInput').click()"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                    style="background-color: var(--text-primary); color: var(--bg-primary);"
                  >
                    Change Picture
                  </button>
                </div>
              </div>
            </div>

            <!-- Group Name -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-300">Group Name</label>
                <span class="text-xs" ng-class="groupSettingsModal.editedName.length > 50 ? 'text-red-400' : 'text-gray-500'">
                  {{ groupSettingsModal.editedName.length }}/50
                </span>
              </div>
              <input
                type="text"
                ng-model="groupSettingsModal.editedName"
                ng-disabled="!groupSettingsModal.isOwner || isImportedGroup(groupSettingsModal.group)"
                maxlength="50"
                class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
                ng-class="{'opacity-50 cursor-not-allowed': isImportedGroup(groupSettingsModal.group)}"
                style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                placeholder="Enter group name"
              >
            </div>

            <!-- Group Description -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-300">Group Description</label>
                <span class="text-xs" ng-class="(groupSettingsModal.editedDescription || '').length > 200 ? 'text-red-400' : 'text-gray-500'">
                  {{ (groupSettingsModal.editedDescription || '').length }}/200
                </span>
              </div>
              <textarea
                ng-model="groupSettingsModal.editedDescription"
                ng-disabled="!groupSettingsModal.isOwner || isImportedGroup(groupSettingsModal.group)"
                maxlength="200"
                rows="3"
                class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 resize-none"
                ng-class="{'opacity-50 cursor-not-allowed': isImportedGroup(groupSettingsModal.group)}"
                style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                placeholder="Enter group description (optional)"
              ></textarea>
            </div>

            <!-- Group ID (for admins/owner) - Hidden for imported groups -->
            <div ng-if="groupSettingsModal.isAdmin && !isImportedGroup(groupSettingsModal.group)" class="mb-6">
              <label class="block text-sm font-medium text-gray-300 mb-2">Group ID</label>
              <div class="flex gap-2">
                <input
                  type="text"
                  ng-model="groupSettingsModal.group.id"
                  readonly
                  class="flex-1 px-4 py-2 rounded-lg border"
                  style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary);"
                >
                <button
                  ng-click="copyGroupId()"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-700 hover:bg-gray-600 text-white"
                >
                  Copy
                </button>
              </div>
              <p class="text-xs text-gray-400 mt-1">Share this ID with others to invite them to the group</p>
            </div>

            <!-- Invite Link (for admins/owner) - Hidden for imported groups -->
            <div ng-if="groupSettingsModal.isAdmin && !isImportedGroup(groupSettingsModal.group)" class="mb-6">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
                Invite Link
              </label>
              <div class="flex gap-2">
                <input
                  type="text"
                  ng-model="groupSettingsModal.inviteLink"
                  readonly
                  class="flex-1 px-4 py-2 rounded-lg border text-sm font-mono"
                  style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary);"
                  title="Click 'Copy Link' to copy this invite link"
                >
                <button
                  ng-click="copyInviteLink()"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2"
                  title="Copy invite link to clipboard"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                  Copy Link
                </button>
              </div>
              <p class="text-xs text-gray-400 mt-1">
                <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                Share this link to automatically invite people to the group. New users will be prompted to create an account first.
              </p>
            </div>

            <!-- Save Button -->
            <div ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)" class="flex justify-end">
              <button
                ng-click="saveGroupBasicInfo()"
                ng-disabled="groupSettingsModal.saving"
                class="px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50"
                style="background-color: var(--text-primary); color: var(--bg-primary);"
              >
                <span ng-if="!groupSettingsModal.saving">Save Changes</span>
                <span ng-if="groupSettingsModal.saving" class="flex items-center gap-2">
                  <span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                  Saving...
                </span>
              </button>
            </div>
          </div>

          <!-- Members Tab -->
          <div ng-if="groupSettingsModal.activeTab === 'members'">
            <!-- Add Member Section (for admins/owner) - Disabled for imported groups -->
            <div ng-if="groupSettingsModal.isAdmin && !isImportedGroup(groupSettingsModal.group)" class="mb-6">
              <div class="rounded-xl p-5 border" style="background-color: #000000; border-color: var(--border-color);">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5" style="color: var(--success-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                  </svg>
                  <h3 class="text-sm font-semibold text-white">Add Member</h3>
                </div>
                <div class="flex gap-2">
                  <input
                    type="email"
                    ng-model="groupSettingsModal.addMemberEmail"
                    placeholder="Enter email address"
                    class="flex-1 px-4 py-2.5 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
                    style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--success-color);"
                  >
                  <button
                    ng-click="addMemberToGroup()"
                    class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 hover:opacity-90 flex items-center gap-2"
                    style="background-color: var(--success-color); color: white;"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add
                  </button>
                </div>
              </div>
            </div>

            <!-- Imported Group Notice for Members Tab -->
            <div ng-if="isImportedGroup(groupSettingsModal.group)" class="mb-6 p-4 rounded-lg border" style="background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3);">
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-yellow-400">Imported Group - Read Only</h4>
                  <p class="text-xs text-yellow-300 mt-1">You cannot add or remove members from imported groups. This is a backup of chat history only.</p>
                </div>
              </div>
            </div>

            <!-- Search Members -->
            <div class="mb-4">
              <div class="relative">
                <input
                  type="text"
                  ng-model="groupSettingsModal.memberSearch"
                  placeholder="Search members..."
                  class="w-full px-4 py-2.5 pl-10 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
                  style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                >
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>

            <!-- Members Count -->
            <div class="mb-3 flex items-center justify-between">
              <h3 class="text-sm font-medium text-gray-300">
                Members <span class="text-gray-500">({{ getFilteredMembers().length }})</span>
              </h3>
            </div>

            <!-- Members List with Scrollbar -->
            <div class="space-y-2 overflow-y-auto pr-2 members-list-container" style="max-height: 400px;">
              <div
                ng-repeat="participant in getFilteredMembers() track by participant"
                class="group relative rounded-xl p-4 border hover:border-gray-600 transition-all duration-200"
                style="background-color: #000000; border-color: var(--border-color);"
              >
                
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <!-- Profile Picture with Status Dot -->
                    <div class="relative">
                      <img
                        ng-src="{{ getProfilePicture(groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].profile_picture) }}"
                        auth-image="{{ getProfilePicture(groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].profile_picture) }}"
                        alt="{{ groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].username }}"
                        class="w-12 h-12 rounded-full ring-2 ring-gray-700 group-hover:ring-gray-600 transition-all"
                      >
                      <!-- Status Dot -->
                      <div 
                        class="absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2"
                        style="border-color: #000000;"
                        ng-class="{
                          'bg-green-500': groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].online && !groupSettingsModal.memberInfo[participant].idle,
                          'bg-yellow-500': groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].idle,
                          'bg-gray-500': !groupSettingsModal.memberInfo[participant] || (!groupSettingsModal.memberInfo[participant].online && !groupSettingsModal.memberInfo[participant].idle)
                        }"
                      ></div>
                    </div>
                    <div class="flex-1 min-w-0">
                      <!-- Name -->
                      <p class="text-sm font-semibold text-white truncate">
                        {{ (groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].name) || 'Loading...' }}
                      </p>
                      <!-- Username -->
                      <p class="text-xs text-gray-400 truncate">
                        @{{ (groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].username) || participant.split('@')[0] }}
                      </p>
                      <!-- Badges -->
                      <div class="flex items-center gap-1.5 mt-1.5 flex-wrap">
                        <span ng-if="isOwner(participant)" class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                          </svg>
                          Owner
                        </span>
                        <span ng-if="isAdmin(participant) && !isOwner(participant)" class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                          </svg>
                          Admin
                        </span>
                        <span 
                          ng-repeat="roleName in getUserRoles(participant)" 
                          class="text-xs px-2 py-0.5 rounded-full border" 
                          ng-style="{'background-color': getRoleColor(roleName) + '33', 'border-color': getRoleColor(roleName) + '66', 'color': getRoleColor(roleName)}"
                        >
                          {{ roleName }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Actions (for owner/admin) - Disabled for imported groups -->
                  <div ng-if="groupSettingsModal.isOwner && participant !== groupSettingsModal.group.owner && !isImportedGroup(groupSettingsModal.group)" class="flex items-center gap-2">
                    <button
                      ng-if="!isAdmin(participant)"
                      ng-click="promoteToAdmin(participant)"
                      class="px-3 py-1.5 text-xs rounded-lg font-medium bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 border border-blue-500/30 transition-all duration-200"
                    >
                      Promote
                    </button>
                    <button
                      ng-if="isAdmin(participant) && !isOwner(participant)"
                      ng-click="demoteFromAdmin(participant)"
                      class="px-3 py-1.5 text-xs rounded-lg font-medium bg-gray-600/50 text-gray-300 hover:bg-gray-600 border border-gray-600 transition-all duration-200"
                    >
                      Demote
                    </button>
                    <button
                      ng-click="removeMemberFromGroup(participant)"
                      class="px-3 py-1.5 text-xs rounded-lg font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 transition-all duration-200"
                    >
                      Remove
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- No Members Found -->
              <div ng-if="getFilteredMembers().length === 0" class="text-center py-8">
                <svg class="w-12 h-12 text-gray-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-gray-400 text-sm">No members found</p>
              </div>
            </div>
          </div>

          <!-- Roles Tab -->
          <div ng-if="groupSettingsModal.activeTab === 'roles'">
            <!-- Imported Group Notice for Roles Tab -->
            <div ng-if="isImportedGroup(groupSettingsModal.group)" class="mb-6 p-4 rounded-lg border" style="background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3);">
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-yellow-400">Imported Group - No Role Management</h4>
                  <p class="text-xs text-yellow-300 mt-1">You cannot create or manage roles for imported groups. This is a backup of chat history only.</p>
                </div>
              </div>
            </div>

            <!-- Create Role Section (for owner) - Disabled for imported groups -->
            <div ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)" class="mb-6">
              <div class="rounded-xl p-5 border" style="background-color: #000000; border-color: var(--border-color);">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5" style="color: var(--success-color);" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <h3 class="text-sm font-semibold text-white">Create New Role</h3>
                </div>
                <div class="flex gap-2">
                  <input
                    type="text"
                    ng-model="groupSettingsModal.newRoleName"
                    maxlength="30"
                    placeholder="Role name"
                    class="flex-1 px-4 py-2.5 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
                    style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                  >
                  <!-- Coloris Color Picker -->
                  <div class="relative">
                    <!-- Color Picker Input -->
                    <input
                      type="text"
                      ng-model="groupSettingsModal.newRoleColor"
                      data-coloris
                      class="w-12 h-[42px] rounded-lg border-2 cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg text-transparent"
                      ng-style="{'border-color': 'var(--border-color)', 'background-color': groupSettingsModal.newRoleColor}"
                      title="Pick a color"
                      readonly
                    >
                  </div>
                  <button
                    ng-click="createRole()"
                    class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center gap-2"
                    style="background-color: var(--text-primary); color: var(--bg-primary);"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Create
                  </button>
                </div>
              </div>
            </div>

            <!-- Roles Count -->
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-sm font-medium text-gray-300">
                Roles <span class="text-gray-500">({{ groupSettingsModal.roles.length }})</span>
              </h3>
            </div>

            <!-- Roles List -->
            <div class="space-y-3 overflow-y-auto group-settings-scrollable" style="max-height: 500px;">
              <div
                ng-repeat="role in groupSettingsModal.roles"
                class="rounded-xl p-5 border hover:border-gray-600 transition-all duration-200"
                style="background-color: #000000; border-color: var(--border-color);"
              >
                <!-- Role Header -->
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-lg shadow-lg transition-transform hover:scale-110 ring-2 ring-gray-700" ng-style="{'background-color': role.color}"></div>
                    <span class="text-base font-semibold text-white">{{ role.name }}</span>
                    <span class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">
                      {{ getRoleMembersCount(role.name) }} {{ getRoleMembersCount(role.name) === 1 ? 'member' : 'members' }}
                    </span>
                  </div>
                  <button
                    ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)"
                    ng-click="deleteRole(role.name)"
                    class="px-3 py-1.5 text-xs rounded-lg font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 transition-all duration-200"
                  >
                    Delete
                  </button>
                </div>

                <!-- Assign Role Section -->
                <div ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)" class="mb-4 p-4 rounded-xl border" style="background-color: #000000; border-color: var(--border-color);">
                  <label class="block text-sm font-medium text-gray-300 mb-3">Assign to Member</label>
                  
                  <!-- Custom Dropdown -->
                  <div class="relative role-assign-dropdown">
                    <button
                      ng-click="toggleRoleAssignDropdown(role)"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-lg border text-left focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:border-gray-600"
                      style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                    >
                      <span class="text-sm text-gray-400">Select a member...</span>
                      <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" ng-class="{'rotate-180': isRoleDropdownOpen(role.name)}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div ng-if="isRoleDropdownOpen(role.name)" class="absolute z-50 w-full mt-2 rounded-xl border shadow-2xl dropdown-menu" style="background-color: #000000; border-color: var(--border-color);">
                      <!-- Search Input -->
                      <div class="p-3 border-b" style="border-color: var(--border-color);">
                        <div class="relative">
                          <input
                            type="text"
                            ng-model="roleAssignDropdowns[role.name].searchQuery"
                            placeholder="Search members..."
                            class="w-full px-3 py-2 pl-9 rounded-lg border text-sm focus:outline-none focus:ring-2 focus:border-transparent transition-all"
                            style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
                          >
                          <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                          </svg>
                        </div>
                      </div>
                      
                      <!-- Members List -->
                      <div class="max-h-64 overflow-y-auto dropdown-members-list">
                        <div
                          ng-repeat="participant in getFilteredMembersForRoleAssignment(role.name) track by participant"
                          ng-click="assignRoleAndClose(participant, role.name)"
                          class="flex items-center gap-3 px-4 py-3 hover:bg-gray-800/50 cursor-pointer transition-all duration-200 border-b last:border-b-0 member-item"
                          style="border-color: var(--border-color);"
                        >
                          <!-- Profile Picture -->
                          <img
                            ng-src="{{ getProfilePicture(groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].profile_picture) }}"
                            auth-image="{{ getProfilePicture(groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].profile_picture) }}"
                            alt="{{ groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].username }}"
                            class="w-10 h-10 rounded-full ring-2 ring-gray-700 flex-shrink-0"
                          >
                          
                          <!-- Member Info -->
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-white truncate">
                              {{ (groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].name) || 'Loading...' }}
                            </p>
                            <p class="text-xs text-gray-400 truncate">
                              @{{ (groupSettingsModal.memberInfo[participant] && groupSettingsModal.memberInfo[participant].username) || participant.split('@')[0] }}
                            </p>
                          </div>
                          
                          <!-- Role Badges -->
                          <div class="flex items-center gap-1.5 flex-shrink-0">
                            <span ng-if="isOwner(participant)" class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
                              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                              </svg>
                              Owner
                            </span>
                            <span ng-if="isAdmin(participant) && !isOwner(participant)" class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">
                              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                              </svg>
                              Admin
                            </span>
                          </div>
                        </div>
                        
                        <!-- No Members Found -->
                        <div ng-if="getFilteredMembersForRoleAssignment(role.name).length === 0 && !allMembersHaveRole(role.name)" class="px-4 py-6 text-center">
                          <svg class="w-8 h-8 text-gray-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                          </svg>
                          <p class="text-sm text-gray-400">No members found</p>
                        </div>
                        
                        <!-- All Members Already Have Role -->
                        <div ng-if="allMembersHaveRole(role.name)" class="px-4 py-6 text-center">
                          <svg class="w-8 h-8 text-gray-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          <p class="text-sm text-gray-400">All members already have this role</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Members with this Role -->
                <div>
                  <p class="text-xs font-medium text-gray-400 mb-2">Members with this role</p>
                  <div class="space-y-2">
                    <div
                      ng-repeat="email in getMembersWithRole(role.name)"
                      class="flex items-center justify-between p-2.5 rounded-lg border hover:border-gray-600 transition-all"
                      style="background-color: #000000; border-color: var(--border-color);"
                    >
                      <div class="flex items-center gap-2">
                        <img
                          ng-src="{{ getProfilePicture((groupSettingsModal.memberInfo[email] && groupSettingsModal.memberInfo[email].profile_picture)) }}"
                          auth-image="{{ getProfilePicture((groupSettingsModal.memberInfo[email] && groupSettingsModal.memberInfo[email].profile_picture)) }}"
                          alt="{{ (groupSettingsModal.memberInfo[email] && groupSettingsModal.memberInfo[email].username) }}"
                          class="w-7 h-7 rounded-full ring-1 ring-gray-700"
                        >
                        <div>
                          <p class="text-sm font-medium text-white">{{ (groupSettingsModal.memberInfo[email] && groupSettingsModal.memberInfo[email].name) || 'Loading...' }}</p>
                          <p class="text-xs text-gray-400">@{{ (groupSettingsModal.memberInfo[email] && groupSettingsModal.memberInfo[email].username) || email.split('@')[0] }}</p>
                        </div>
                      </div>
                      <button
                        ng-if="groupSettingsModal.isOwner && !isImportedGroup(groupSettingsModal.group)"
                        ng-click="unassignRoleFromMember(email, role.name)"
                        class="text-xs px-2 py-1 rounded-lg text-red-400 hover:bg-red-500/20 transition-all"
                      >
                        Remove
                      </button>
                    </div>
                    <p ng-if="!hasRoleAssignments(role.name)" class="text-xs text-gray-500 italic text-center py-2">No members assigned yet</p>
                  </div>
                </div>
              </div>

              <!-- No Roles State -->
              <div ng-if="groupSettingsModal.roles.length === 0" class="text-center py-12">
                <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <p class="text-gray-400 font-medium">No roles created yet</p>
                <p class="text-gray-500 text-sm mt-1">Create roles to organize your group members</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Contact Context Menu -->
    <div 
      ng-if="searchContactMenu.show" 
      class="fixed z-50 border rounded-lg shadow-2xl py-2 min-w-48"
      style="background-color: var(--bg-secondary); border-color: var(--border-color);"
      ng-style="{ left: searchContactMenu.x + 'px', top: searchContactMenu.y + 'px' }"
      ng-click="$event.stopPropagation()"
    >
      <div 
        class="px-4 py-2.5 cursor-pointer transition-colors duration-150 flex items-center space-x-3 text-white hover:bg-gray-700/50"
        ng-click="viewChatFromMenu()"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        <span class="text-sm">View Chat</span>
      </div>
      <div 
        class="px-4 py-2.5 cursor-pointer transition-colors duration-150 flex items-center space-x-3 text-red-400 hover:bg-red-500/10"
        ng-click="removeContactFromMenu()"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
        </svg>
        <span class="text-sm">Remove Contact</span>
      </div>
    </div>

    <!-- Context Menu -->
    <div 
      ng-if="contextMenu.show" 
      class="fixed border rounded-lg shadow-2xl py-2 min-w-48"
      style="background-color: var(--bg-secondary); border-color: var(--border-color); z-index: 99999;"
      ng-style="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }"
      ng-click="$event.stopPropagation()"
    >
      <!-- Archive Chat/Group -->
      <button
        ng-click="archiveChat(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <span ng-if="!contextMenu.contact.archived && !contextMenu.contact.isGroup">Archive chat</span>
        <span ng-if="contextMenu.contact.archived && !contextMenu.contact.isGroup">Unarchive chat</span>
        <span ng-if="!contextMenu.contact.archived && contextMenu.contact.isGroup">Archive group</span>
        <span ng-if="contextMenu.contact.archived && contextMenu.contact.isGroup">Unarchive group</span>
      </button>

      <!-- Mute Notifications -->
      <button
        ng-click="muteChat(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
        </svg>
        <span ng-if="!contextMenu.contact.muted">Mute notifications</span>
        <span ng-if="contextMenu.contact.muted">Unmute notifications</span>
      </button>

      <!-- Pin Chat/Group -->
      <button
        ng-click="pinChat(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
        </svg>
        <span ng-if="!contextMenu.contact.pinned && !contextMenu.contact.isGroup">Pin chat</span>
        <span ng-if="contextMenu.contact.pinned && !contextMenu.contact.isGroup">Unpin chat</span>
        <span ng-if="!contextMenu.contact.pinned && contextMenu.contact.isGroup">Pin group</span>
        <span ng-if="contextMenu.contact.pinned && contextMenu.contact.isGroup">Unpin group</span>
      </button>

      <!-- Mark as Read (only show if there are unread messages) -->
      <button
        ng-if="contextMenu.contact.unreadCount > 0"
        ng-click="markAsRead(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Mark as read ({{ contextMenu.contact.unreadCount }})</span>
      </button>

      <!-- Add to Favorites -->
      <button
        ng-click="addToFavorites(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-white hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
        </svg>
        <span ng-if="!contextMenu.contact.favorited && !contextMenu.contact.is_favorited">Add to favorites</span>
        <span ng-if="contextMenu.contact.favorited || contextMenu.contact.is_favorited">Remove from favorites</span>
      </button>

      <!-- Divider -->
      <div class="border-t border-gray-700 my-2"></div>

      <!-- Block (only for contacts) -->
      <button
        ng-if="!contextMenu.contact.isGroup"
        ng-click="blockContact(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-red-400 hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
        </svg>
        <span>Block</span>
      </button>

      <!-- Leave Group (only for groups, not for owners) -->
      <button
        ng-if="contextMenu.contact.isGroup && contextMenu.contact.owner !== currentUser.email"
        ng-click="leaveGroup(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-red-400 hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        <span>Leave Group</span>
      </button>

      <!-- Delete Chat -->
      <button
        ng-click="deleteChat(contextMenu.contact)"
        class="w-full px-4 py-2 text-left text-red-400 hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-3"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        <span ng-if="!contextMenu.contact.isGroup">Delete chat</span>
        <span ng-if="contextMenu.contact.isGroup">Delete group</span>
      </button>
    </div>

    <!-- Character Limit Modal -->
    <div ng-if="characterLimitModal.show" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div 
        ng-click="hideCharacterLimitModal()" 
        class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
      ></div>
      
      <!-- Modal -->
      <div class="relative rounded-2xl shadow-2xl border p-6 w-full max-w-md mx-4 fade-in" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="w-16 h-16 bg-yellow-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg ng-if="characterLimitModal.type === 'message'" class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <svg ng-if="characterLimitModal.type === 'image'" class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <svg ng-if="characterLimitModal.type === 'file'" class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-3">{{ characterLimitModal.title }}</h3>
          <p class="text-gray-400 text-sm leading-relaxed break-words overflow-wrap-anywhere">
            {{ characterLimitModal.message }}
          </p>
        </div>

        <!-- Button -->
        <div class="flex justify-center">
          <button 
            ng-click="hideCharacterLimitModal()"
            class="bg-yellow-600 hover:bg-yellow-700 text-white py-2.5 px-6 rounded-lg transition-colors duration-200 text-sm font-medium"
          >
            Got it!
          </button>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col relative overflow-hidden mobile-chat-area" ng-class="{'mobile-hide': isMobile}" style="background-color: var(--bg-primary); max-width: 100%;">
      <!-- Mobile Header (only visible on mobile) -->
      <div ng-if="isMobile" class="mobile-header">
        <button ng-click="toggleMobileSidebar()" class="mobile-hamburger">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <div class="flex items-center gap-2">
          <img src="/src/app/public/logo.png" alt="VibgyorChat" class="w-8 h-8">
          <span class="font-bold text-white">VibgyorChat</span>
        </div>
        <div class="w-10"></div> <!-- Spacer for centering -->
      </div>
      
      <!-- Empty State -->
      <div ng-if="!selectedContact" class="flex-1 flex items-center justify-center pb-24" style="position: relative; z-index: 1;">
        <!-- Mosaic Background for Welcome Screen -->
        <div class="mosaic-bg" id="welcomeMosaicBg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>
        
        <div class="text-center max-w-md" style="position: relative; z-index: 1;">
          <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl" style="background-color: var(--text-primary);">
            <svg class="w-12 h-12" style="color: var(--bg-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
          </div>
          <h3 class="text-2xl font-bold mb-3" style="color: var(--text-primary);">
            Welcome to VibgyorChat
          </h3>
          <p class="leading-relaxed" style="color: var(--text-secondary);">
            Select a conversation from the sidebar to start chatting with your contacts. Experience modern messaging with style.
          </p>
        </div>
      </div>

      <!-- Chat Interface -->
      <div ng-if="selectedContact" class="flex-1 flex flex-col chat-interface" ng-class="{'imported-group-chat': selectedContact.isGroup && isImportedGroup(selectedContact)}">
        <!-- Chat Header -->
        <div class="border-b px-6 py-3 relative" style="background-color: var(--bg-secondary); border-color: var(--border-color); position: relative; z-index: 10;">
          <div class="flex items-center justify-between">
            <!-- Group/Contact Info - Clickable for both groups and contacts -->
            <div 
              class="flex items-center space-x-3 relative"
              ng-class="{'cursor-pointer hover:bg-white/5 rounded-lg transition-colors duration-200 -mx-2 px-2 py-1': (selectedContact.isGroup && !isImportedGroup(selectedContact)) || !selectedContact.isGroup}"
              ng-click="selectedContact.isGroup && !isImportedGroup(selectedContact) ? showGroupSettings() : (!selectedContact.isGroup ? showContactInfo() : null)"
              title="{{ selectedContact.isGroup && !isImportedGroup(selectedContact) ? 'Group Settings' : (!selectedContact.isGroup ? 'Contact Info' : '') }}"
            >
              <!-- Contact profile picture -->
              <img
                ng-if="!selectedContact.isGroup"
                ng-src="{{ getProfilePicture(selectedContact.profile_picture) }}"
                auth-image="{{ getProfilePicture(selectedContact.profile_picture) }}"
                alt="{{ selectedContact.username }}"
                class="w-10 h-10 rounded-full ring-2"
                style="--tw-ring-color: var(--text-primary);"
              >
              <!-- Group profile picture -->
              <img
                ng-if="selectedContact.isGroup"
                ng-src="{{ getGroupPicture(selectedContact) }}"
                alt="{{ selectedContact.name }}"
                class="w-10 h-10 rounded-full ring-2"
                style="--tw-ring-color: var(--text-primary);"
              >
              <div>
                <h2 class="text-base font-semibold text-white">
                  {{ selectedContact.name || selectedContact.username }}
                </h2>
                <!-- Presence Pill (only for contacts, not groups) -->
                <div ng-if="!selectedContact.isGroup" class="presence-pill">
                  <div 
                    class="presence-dot"
                    ng-class="{
                      'presence-dot-online': selectedContact.online && !selectedContact.idle,
                      'presence-dot-idle': selectedContact.idle,
                      'presence-dot-offline': !selectedContact.online && !selectedContact.idle
                    }"
                  ></div>
                  <span class="presence-text">
                    <span ng-if="selectedContact.online && !selectedContact.idle">Online</span>
                    <span ng-if="selectedContact.idle">Idling</span>
                    <span ng-if="!selectedContact.online && !selectedContact.idle && selectedContact.last_seen">Last seen {{ selectedContact.last_seen | discordTime }}</span>
                    <span ng-if="!selectedContact.online && !selectedContact.idle && !selectedContact.last_seen">Offline</span>
                  </span>
                </div>
                <!-- Group member count -->
                <div ng-if="selectedContact.isGroup" class="text-xs text-gray-400">
                  {{ selectedContact.members_count }} member{{ selectedContact.members_count !== 1 ? 's' : '' }}
                </div>
              </div>
            </div>

            <div class="flex items-center space-x-2">
              <button class="p-2 hover:bg-gray-800 rounded-lg transition-colors duration-200" title="Voice call">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
              </button>
              <button class="p-2 hover:bg-gray-800 rounded-lg transition-colors duration-200" title="Video call">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
              <!-- Pinned Messages Button -->
              <button 
                ng-click="togglePinnedMessagesPopup()" 
                class="p-2 hover:bg-gray-800 rounded-lg transition-colors duration-200 relative" 
                title="Pinned Messages"
                ng-class="{'bg-gray-800': showPinnedMessagesPopup}"
              >
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <!-- Red dot notification for new pinned messages -->
                <span 
                  ng-if="hasUnviewedPinnedMessages" 
                  class="absolute top-1 right-1 bg-red-500 rounded-full w-2 h-2"
                ></span>
              </button>
            </div>
          </div>

          <!-- Pinned Messages Popup (Discord-style) -->
          <div 
            ng-if="showPinnedMessagesPopup" 
            class="pinned-messages-popup"
          >
            <div class="pinned-messages-header">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <h3 class="text-base font-semibold text-white">Pinned Messages</h3>
              </div>
              <button 
                ng-click="togglePinnedMessagesPopup()" 
                class="text-gray-400 hover:text-white transition-colors"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="pinned-messages-content">
              <!-- No pinned messages -->
              <div ng-if="pinnedMessages.length === 0" class="text-center py-8">
                <svg class="w-12 h-12 text-gray-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <p class="text-gray-400 text-sm">No pinned messages</p>
              </div>

              <!-- Pinned messages list -->
              <div 
                ng-repeat="message in pinnedMessages" 
                class="pinned-message-item"
                ng-click="scrollToMessage(message); togglePinnedMessagesPopup()"
                style="text-align: left;"
              >
                <div class="flex items-start space-x-3" style="justify-content: flex-start; align-items: flex-start;">
                  <img
                    ng-src="{{ getMessageSenderAvatar(message) }}"
                    auth-image="{{ getMessageSenderAvatar(message) }}"
                    alt="{{ getMessageSenderName(message) }}"
                    class="w-10 h-10 rounded-full flex-shrink-0"
                  >
                  <div class="flex-1 min-w-0" style="text-align: left;">
                    <!-- Header: Name + Time -->
                    <div class="flex items-baseline space-x-2 mb-1" style="justify-content: flex-start;">
                      <span class="font-semibold text-white text-sm" style="text-align: left;">
                        {{ getMessageSenderName(message) }}
                      </span>
                      <span class="text-xs text-gray-400" style="text-align: left;">
                        {{ message.created_at | discordTime }}
                      </span>
                    </div>
                    <!-- Message Body -->
                    <div class="message-content" style="text-align: left; display: block; width: 100%;">
                      <!-- Text content -->
                      <p ng-if="message.content && message.type === 'text'" class="text-gray-100 leading-relaxed whitespace-pre-wrap" style="text-align: left; margin: 0; padding: 0; display: block;">{{ message.content }}</p>
                      
                      <!-- Image Message -->
                      <div ng-if="message.type === 'image' && message.imageUrl && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" class="mt-2">
                        <img
                          ng-src="{{ message.imageUrl }}"
                          alt="{{ message.file_name }}"
                          class="rounded-lg cursor-pointer max-w-xs"
                          style="max-height: 200px; object-fit: contain;"
                          ng-click="openImageViewer(message); $event.stopPropagation()"
                        >
                      </div>
                      
                      <!-- Hidden Image Message for Imported Groups -->
                      <div ng-if="message.type === 'image' && selectedContact.isGroup && isImportedGroup(selectedContact)" class="mt-2 p-3 rounded-lg border border-gray-600 bg-gray-800/30">
                        <div class="flex items-center gap-2 text-gray-400">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"></path>
                          </svg>
                          <span class="text-sm"> Image (hidden in imported group)</span>
                        </div>
                      </div>
                      
                      <!-- File Message -->
                      <div ng-if="message.type === 'file' && message.file_name && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" class="mt-2">
                        <div 
                          class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer hover:bg-gray-800/50 transition-colors max-w-xs"
                          style="background-color: var(--bg-tertiary); border-color: var(--border-color);"
                          ng-click="downloadFile(message); $event.stopPropagation()"
                        >
                          <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background-color: var(--bg-primary);">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block; margin: auto;">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                            <p class="text-xs text-gray-400">Click to download</p>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Hidden File Message for Imported Groups -->
                      <div ng-if="message.type === 'file' && message.file_name && selectedContact.isGroup && isImportedGroup(selectedContact)" class="mt-2 p-3 rounded-lg border border-gray-600 bg-gray-800/30">
                        <div class="flex items-center gap-2 text-gray-400">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                          <span class="text-sm"> File: {{ message.file_name }} (hidden in imported group)</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Imported Group Warning Banner -->
        <div ng-if="selectedContact.isGroup && isImportedGroup(selectedContact)" class="px-6 py-3 border-b" style="background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3);">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-sm font-medium text-yellow-400"> This is an imported Group!</p>
              <p class="text-xs text-yellow-300 mt-0.5">This group was imported from a backup ({{ selectedContact.original_message_count }} messages). Interaction is disabled.</p>
            </div>
          </div>
        </div>
        
        <!-- Messages Area -->
        <div class="messages-area" style="position: relative;">
          <!-- Mosaic Background for Messages -->
          <div class="mosaic-bg" id="messagesMosaicBg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>
          
          <div 
            id="messages-container" 
            class="h-full overflow-y-auto overflow-x-hidden p-4 space-y-1 custom-scrollbar"
            ng-scroll="onScroll($event)"
            onscroll="angular.element(this).scope().onScroll(event)"
            style="scroll-behavior: smooth; position: relative; z-index: 1;"
          >
          <!-- Loading older messages indicator -->
          <div ng-if="loadingOlderMessages" class="text-center py-4">
            <div class="animate-spin w-6 h-6 border-2 border-t-transparent rounded-full mx-auto mb-2" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
            <p class="text-gray-400 text-sm">Loading older messages...</p>
          </div>

          <!-- No more messages indicator -->
          <div ng-if="!loadingOlderMessages && messages.length > 0 && !ChatService.hasMoreMessages" class="text-center py-4">
            <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <p class="text-gray-500 text-xs">You've reached the beginning of this conversation</p>
          </div>

          <div ng-if="messages.length === 0 && !loadingMessages" class="text-center py-12">
            <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">Start the conversation</h3>
            <p class="text-gray-400">Send a message to begin chatting with {{ selectedContact.name || selectedContact.username }}</p>
          </div>

          <!-- Loading messages indicator -->
          <div ng-if="loadingMessages" class="text-center py-12">
            <div class="animate-spin w-8 h-8 border-2 border-t-transparent rounded-full mx-auto mb-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
            <p class="text-gray-400">Loading messages...</p>
          </div>

          <!-- Discord-style Messages -->
          <div
            ng-repeat="message in messages track by (message.id || message._id)"
            ng-if="!shouldHideMessageInImportedGroup(message)"
            class="message-wrapper"
            id="message-{{ message.id }}"
          >
            <!-- Date Divider -->
            <div ng-if="shouldShowDateDivider(message, messages[$index - 1])" class="date-divider">
              <div class="date-divider-line"></div>
              <span class="date-divider-text">{{ formatDateDivider(message.created_at) }}</span>
              <div class="date-divider-line"></div>
            </div>

            <div
              class="discord-message group relative px-4 rounded-md hover:bg-gray-800/30 transition-colors duration-150"
              ng-class="[shouldShowMessageHeader(message, messages[$index - 1], $index) ? 'pt-2 pb-0.5' : 'py-0.5', isMentioned(message) ? 'message-mentioned' : '']"
              ng-mouseenter="message.showHover = true"
              ng-mouseleave="message.showHover = false"
              ng-right-click="onMessageRightClick(message, $event)"
            >
              <!-- Hover Actions -->
              <div ng-if="message.showHover && !message.deleted && !message.is_deleted && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" class="hover-actions opacity-0 group-hover:opacity-100">
                <button 
                  ng-click="replyToMessage(message)"
                  class="hover-action-btn"
                  title="Reply"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                  </svg>
                </button>
                <button 
                  ng-click="forwardMessage(message)"
                  class="hover-action-btn"
                  title="Forward"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                  </svg>
                </button>
                <button 
                  ng-click="showMessageOptions(message, $event)"
                  class="hover-action-btn"
                  title="More"
                >
                  <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                  </svg>
                </button>
              </div>

              <!-- Discord-Style Reply Reference (ABOVE main message) -->
              <div 
                ng-if="message.reply_info" 
                class="discord-reply-container"
                ng-click="scrollToReplyMessage(message.reply_info.reply_to_id)"
              >
                <div class="discord-reply-spine"></div>
                <img
                  ng-src="{{ getProfilePicture(message.reply_info.sender_avatar) }}"
                  auth-image="{{ getProfilePicture(message.reply_info.sender_avatar) }}"
                  alt="{{ message.reply_info.sender_name }}"
                  class="discord-reply-avatar"
                >
                <div class="discord-reply-content">
                  <span class="discord-reply-author">{{ message.reply_info.sender_name }}</span>
                  <span 
                    class="discord-reply-message"
                    ng-class="{ 'discord-reply-deleted': message.reply_info.is_deleted }"
                  >
                    {{ message.reply_info.is_deleted ? 'This message was deleted' : message.reply_info.content }}
                  </span>
                </div>
              </div>

              <!-- Message with Full Header (Profile + Name + Time) -->
              <div ng-if="shouldShowMessageHeader(message, messages[$index - 1], $index)" class="flex items-start space-x-3">
                <!-- Profile Picture -->
                <div class="flex-shrink-0 mt-1">
                  <img
                    ng-src="{{ getMessageSenderAvatar(message) }}"
                    auth-image="{{ getMessageSenderAvatar(message) }}"
                    alt="{{ getMessageSenderName(message) }}"
                    class="w-10 h-10 rounded-full"
                  >
                </div>
                
                <!-- Message Content -->
                <div class="flex-1 min-w-0">
                  <!-- Header: Name + Time + Badges -->
                  <div class="flex items-baseline space-x-2 mb-1">
                    <span 
                      class="font-semibold text-white text-base cursor-pointer hover:underline"
                      ng-click="showUserProfilePopup(message, $event)"
                    >
                      {{ getMessageSenderName(message) }}
                    </span>
                    <span class="text-xs text-gray-400 message-timestamp">
                      {{ message.created_at | discordTime }}
                    </span>
                    <span ng-if="message.pinned" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-yellow-500/20 text-yellow-400">
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                      </svg>
                      Pinned
                    </span>
                    <span ng-if="message.edited && !message.deleted" class="text-xs text-gray-500" title="{{ message.edited_at | discordTimeTooltip }}">
                      (edited {{ message.edited_at | discordTime }})
                    </span>
                  </div>

                  <!-- Message Body -->
                  <div class="message-content">
                  
                  <!-- Text Message -->
                  <div ng-if="isTextMessage(message) && !isMediaMessage(message)">
                    <!-- Deleted Message -->
                    <p ng-if="message.deleted || message.is_deleted" class="text-gray-500 italic text-sm">This message was deleted</p>
                    
                    <!-- Edit Mode -->
                    <div ng-if="!message.deleted && !message.is_deleted && message.isEditing" class="edit-message-container">
                      <textarea 
                        ng-model="message.editContent"
                        class="edit-message-input"
                        ng-keydown="onEditKeyDown($event, message)"
                        placeholder="Edit your message..."
                      ></textarea>
                      <div class="edit-message-hint">
                        escape to <span>cancel</span>  enter to <span>save</span>
                      </div>
                    </div>
                    
                    <!-- Normal Display -->
                    <div ng-if="!message.deleted && !message.is_deleted && !message.isEditing">
                      <p class="text-gray-100 leading-relaxed whitespace-pre-wrap" render-mentions="parseMentions(message.content)"></p>
                    </div>
                  </div>

                  <!-- Image Message (from socket) -->
                  <div ng-if="isImageMessage(message)" class="mt-2">
                    <div ng-if="message.file_data" class="image-attachment inline-block max-w-md">
                      <img 
                        ng-src="data:image/jpeg;base64,{{ message.file_data }}" 
                        alt="Image"
                        class="max-w-full h-auto max-h-96 cursor-pointer hover:opacity-90 transition-opacity"
                        ng-click="downloadFile(message)"
                      >
                    </div>
                  </div>

                    <!-- File Message (from socket) -->
                  <div ng-if="isFileMessage(message)" class="mt-2">
                    <div class="file-attachment flex items-center space-x-3 p-3 cursor-pointer max-w-md" ng-click="downloadFile(message)">
                      <div class="flex-shrink-0">
                        <!-- PDF Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'pdf'" class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Word Document Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'document'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Excel/Spreadsheet Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'spreadsheet'" class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Video Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'video'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h6a2 2 0 012 2v2.553a1 1 0 00.553.894l2 1A1 1 0 0016 9.553V6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2v-3.553a1 1 0 00-1.447-.894l-2 1A1 1 0 0012 11.447V14a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Audio Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'audio'" class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12a7.971 7.971 0 00-1.343-4.243 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Archive/Zip Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'archive'" class="w-8 h-8 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                          <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Generic File Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'file'" class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <p ng-if="message.file_size" class="text-xs text-gray-400">{{ formatFileSize(message.file_size) }}</p>
                        <p ng-if="!message.file_size" class="text-xs text-gray-400">Click to download</p>
                      </div>
                      <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <!-- Media Message (from database) -->
                  <div ng-if="isMediaMessage(message) && !isFileMessage(message)" class="mt-2">
                    <!-- Image Media -->
                    <div ng-if="message.isImage && message.imageUrl" class="image-attachment inline-block max-w-md">
                      <img 
                        ng-src="{{ message.imageUrl }}" 
                        alt="Image"
                        class="max-w-full h-auto max-h-96 rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                        ng-click="downloadMediaFile(message)"
                      >
                    </div>

                    <!-- Audio Media -->
                    <div ng-if="!message.isImage && isAudioFile(message.file_name)" class="file-attachment flex items-center space-x-3 p-3 max-w-md">
                      <div class="flex-shrink-0">
                        <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12a7.971 7.971 0 00-1.343-4.243 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                          <path fill-rule="evenodd" d="M13.828 8.172a1 1 0 011.414 0A5.983 5.983 0 0117 12a5.983 5.983 0 01-1.758 3.828 1 1 0 11-1.414-1.414A3.987 3.987 0 0015 12a3.987 3.987 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <audio controls class="w-full mt-2" preload="none">
                          <source ng-src="{{ getMediaUrl(message) }}" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      </div>
                    </div>

                    <!-- Other File Media -->
                    <div ng-if="!message.isImage && !isAudioFile(message.file_name)" class="file-attachment flex items-center space-x-3 p-3 cursor-pointer max-w-md" ng-click="downloadMediaFile(message)">
                      <div class="flex-shrink-0">
                        <!-- PDF Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'pdf'" class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Word Document Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'document'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Excel/Spreadsheet Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'spreadsheet'" class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Video Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'video'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h6a2 2 0 012 2v2.553a1 1 0 00.553.894l2 1A1 1 0 0016 9.553V6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2v-3.553a1 1 0 00-1.447-.894l-2 1A1 1 0 0012 11.447V14a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Archive/Zip Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'archive'" class="w-8 h-8 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                          <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Generic File Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'file'" class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <p class="text-xs text-gray-400">Click to download</p>
                      </div>
                      <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Grouped Message (No Header - Same sender within time limit) -->
            <div ng-if="!shouldShowMessageHeader(message, messages[$index - 1], $index)" class="flex items-start space-x-3">
              <!-- Compact timestamp on left (shows on hover) - Same width as profile pic area -->
              <div class="flex-shrink-0 w-10 flex items-center justify-end">
                <span class="grouped-message-timestamp text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                  {{ formatTimeOnly(message.created_at) }}
                </span>
              </div>
              
              <!-- Message Content Only -->
              <div class="flex-1 min-w-0">
                <!-- Message Body -->
                <div class="message-content">
                  
                  <!-- Text Message -->
                  <div ng-if="isTextMessage(message) && !isMediaMessage(message)">
                    <!-- Deleted Message -->
                    <p ng-if="message.deleted || message.is_deleted" class="text-gray-500 italic text-sm">This message was deleted</p>
                    
                    <!-- Edit Mode -->
                    <div ng-if="!message.deleted && !message.is_deleted && message.isEditing" class="edit-message-container">
                      <textarea 
                        ng-model="message.editContent"
                        class="edit-message-input"
                        ng-keydown="onEditKeyDown($event, message)"
                        placeholder="Edit your message..."
                      ></textarea>
                      <div class="edit-message-hint">
                        escape to <span>cancel</span>  enter to <span>save</span>
                      </div>
                    </div>
                    
                    <!-- Normal Display -->
                    <div ng-if="!message.deleted && !message.is_deleted && !message.isEditing">
                      <p class="text-gray-100 leading-relaxed whitespace-pre-wrap" render-mentions="parseMentions(message.content)"></p><span ng-if="message.edited || message.edited_at" class="text-gray-500 text-xs ml-1.5">(edited)</span>
                    </div>
                  </div>

                  <!-- Image Message (from socket) -->
                  <div ng-if="isImageMessage(message)" class="mt-2">
                    <div ng-if="message.file_data" class="image-attachment inline-block max-w-md">
                      <img 
                        ng-src="data:image/jpeg;base64,{{ message.file_data }}" 
                        alt="Image"
                        class="max-w-full h-auto max-h-96 cursor-pointer hover:opacity-90 transition-opacity"
                        ng-click="downloadFile(message)"
                      >
                    </div>
                  </div>

                  <!-- File Message (from socket) -->
                  <div ng-if="isFileMessage(message)" class="mt-2">
                    <div class="file-attachment flex items-center space-x-3 p-3 cursor-pointer max-w-md" ng-click="downloadFile(message)">
                      <div class="flex-shrink-0">
                        <!-- PDF Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'pdf'" class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Word Document Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'document'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Excel/Spreadsheet Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'spreadsheet'" class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Video Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'video'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h6a2 2 0 012 2v2.553a1 1 0 00.553.894l2 1A1 1 0 0016 9.553V6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2v-3.553a1 1 0 00-1.447-.894l-2 1A1 1 0 0012 11.447V14a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Audio Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'audio'" class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12a7.971 7.971 0 00-1.343-4.243 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Archive/Zip Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'archive'" class="w-8 h-8 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                          <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Generic File Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'file'" class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <p ng-if="message.file_size" class="text-xs text-gray-400">{{ formatFileSize(message.file_size) }}</p>
                        <p ng-if="!message.file_size" class="text-xs text-gray-400">Click to download</p>
                      </div>
                      <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <!-- Media Message (from database) -->
                  <div ng-if="isMediaMessage(message) && !isFileMessage(message)" class="mt-2">
                    <!-- Image Media -->
                    <div ng-if="message.isImage && message.imageUrl" class="image-attachment inline-block max-w-md">
                      <img 
                        ng-src="{{ message.imageUrl }}" 
                        alt="Image"
                        class="max-w-full h-auto max-h-96 rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                        ng-click="downloadMediaFile(message)"
                      >
                    </div>

                    <!-- Audio Media -->
                    <div ng-if="!message.isImage && isAudioFile(message.file_name)" class="file-attachment flex items-center space-x-3 p-3 max-w-md">
                      <div class="flex-shrink-0">
                        <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12a7.971 7.971 0 00-1.343-4.243 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                          <path fill-rule="evenodd" d="M13.828 8.172a1 1 0 011.414 0A5.983 5.983 0 0117 12a5.983 5.983 0 01-1.758 3.828 1 1 0 11-1.414-1.414A3.987 3.987 0 0015 12a3.987 3.987 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <audio controls class="w-full mt-2" preload="none">
                          <source ng-src="{{ getMediaUrl(message) }}" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      </div>
                    </div>

                    <!-- Other File Media -->
                    <div ng-if="!message.isImage && !isAudioFile(message.file_name)" class="file-attachment flex items-center space-x-3 p-3 cursor-pointer max-w-md" ng-click="downloadMediaFile(message)">
                      <div class="flex-shrink-0">
                        <!-- PDF Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'pdf'" class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Word Document Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'document'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Excel/Spreadsheet Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'spreadsheet'" class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Video Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'video'" class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h6a2 2 0 012 2v2.553a1 1 0 00.553.894l2 1A1 1 0 0016 9.553V6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2v-3.553a1 1 0 00-1.447-.894l-2 1A1 1 0 0012 11.447V14a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Archive/Zip Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'archive'" class="w-8 h-8 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                          <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Generic File Icon -->
                        <svg ng-if="getFileIcon(message.file_name) === 'file'" class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                        <p class="text-xs text-gray-400">Click to download</p>
                      </div>
                      <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Hover Actions (Discord-style) -->
            <div 
              ng-if="message.showHover && !message.deleted && !message.is_deleted && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" 
              class="hover-actions"
            >
              <!-- Reply Button -->
              <button
                type="button"
                class="hover-action-btn"
                title="Reply"
                ng-click="replyToMessage(message)"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
              </button>

              <!-- Forward Button -->
              <button
                type="button"
                class="hover-action-btn"
                title="Forward"
                ng-click="forwardMessage(message)"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6-6m6 6l-6 6"></path>
                </svg>
              </button>

              <!-- More Options -->
              <button
                type="button"
                class="hover-action-btn"
                title="More options"
                ng-click="showMessageOptions(message, $event)"
              >
                <svg fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                </svg>
              </button>
            </div>
          </div>

            <!-- Pin Notification System Message (appears after pinned message) -->
            <div ng-if="message.pinned || message.is_pinned" class="px-4 py-2">
              <div class="flex items-center gap-2 text-xs text-gray-400">
                <svg class="w-3.5 h-3.5 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <span>
                  <span class="font-semibold text-white">{{ getMessageSenderName(message) }}</span>
                  <span> pinned </span>
                  <span 
                    class="text-blue-400 hover:underline cursor-pointer" 
                    ng-click="scrollToMessage(message)"
                  >
                    a message
                  </span>
                  <span> to this chat. </span>
                  <span 
                    class="text-blue-400 hover:underline cursor-pointer ml-1" 
                    ng-click="togglePinnedMessagesPopup(); $event.stopPropagation();"
                  >
                    See all pinned messages
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Jump to Present Button (positioned relative to chat interface) -->
        <div 
          ng-if="showJumpToPresent" 
          class="jump-to-present-container"
          ng-style="{'opacity': jumpToPresentLoaded ? '1' : '0'}"
        >
          <div class="jump-to-present-wrapper">
            <span class="jump-to-present-text">You're Viewing Older Messages</span>
            <button
              ng-click="jumpToPresent()"
              class="jump-to-present-button"
            >
              Jump To Present
            </button>
          </div>
        </div>

        <!-- Message Input - Floating WhatsApp Style -->
        <div class="input-area p-4">
          <!-- Emoji Picker Popup -->
          <div ng-if="showEmojiPicker" class="emoji-picker-popup" id="emojiPickerPopup">
            <!-- Emoji picker will be dynamically inserted here -->
          </div>

          <!-- Typing Indicator (stuck to input box) -->
          <div ng-if="isAnyoneTyping()" class="typing-indicator-container-sticky">
            <div class="typing-indicator-pill">
              <div class="typing-indicator-dot"></div>
            </div>
            <span class="typing-indicator-text">{{ getTypingUserName() }} typing...</span>
          </div>

          <div class="backdrop-blur-sm rounded-2xl shadow-2xl border floating-input relative" style="background-color: #000000; border-color: var(--border-color); position: relative; z-index: 10;">
            <!-- Reply Indicator -->
            <div ng-if="replyingTo" class="reply-indicator">
              <div class="reply-indicator-content">
                <div class="reply-indicator-header">
                  Replying to {{ replyingTo.sender_name }}
                </div>
                <div class="reply-indicator-message">
                  {{ replyingTo.content }}
                </div>
              </div>
              <button type="button" ng-click="cancelReply()" class="reply-indicator-close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- File Preview - Multiple Files Support -->
            <div ng-if="filePreviews.length > 0" class="file-previews-container">
              <div class="file-previews-scroll">
                <div ng-repeat="preview in filePreviews" class="file-preview-item">
                  <!-- Image Preview -->
                  <div ng-if="preview.fileType === 'image'" class="preview-thumbnail">
                    <img ng-src="{{ preview.previewUrl }}" alt="{{ preview.fileName }}" class="preview-img">
                    <button type="button" ng-click="removeFilePreview($index)" class="preview-remove-btn" title="Remove">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- File Preview -->
                  <div ng-if="preview.fileType === 'file'" class="preview-file">
                    <div class="preview-file-icon">
                      <svg class="w-8 h-8" style="color: var(--text-primary);" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                    <p class="preview-file-name">{{ preview.fileName }}</p>
                    <button type="button" ng-click="removeFilePreview($index)" class="preview-remove-btn" title="Remove">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Attachment Menu -->
            <div ng-if="showAttachmentMenu" class="attachment-menu">
              <div class="attachment-menu-item" ng-click="selectImage()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Send Image
              </div>
              <div class="attachment-menu-item" ng-click="selectFile()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Send File
              </div>
            </div>
            
            
            <form ng-submit="sendMessage($event)" class="flex items-center space-x-3 p-3 relative" ng-if="!selectedContact.isGroup || !isImportedGroup(selectedContact)">
              <!-- Plus Button -->
              <button
                type="button"
                ng-click="toggleAttachmentMenu()"
                ng-disabled="uploadingFile"
                class="flex-shrink-0 w-10 h-10 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-full flex items-center justify-center transition-colors duration-200 shadow-lg"
                style="background-color: var(--text-primary); color: var(--bg-primary);"
                title="Attach file"
              >
                <svg ng-if="!uploadingFile" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <div ng-if="uploadingFile" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--bg-primary); border-top-color: transparent;"></div>
              </button>
              
              <!-- Message Input Container -->
              <div class="flex-1 relative rounded-2xl border transition-colors duration-200 flex items-center" style="background-color: #000000; border-color: var(--border-color);">
                <!-- Mention Suggestions Dropdown -->
                <div 
                  ng-if="showMentionSuggestions && (memberSuggestions.length > 0 || roleSuggestions.length > 0)"
                  class="absolute bottom-full left-0 right-0 mb-2 rounded-lg shadow-2xl overflow-hidden mention-suggestions"
                  style="background-color: #111111; border: 1px solid #2b2d31; z-index: 9999;"
                >
                  <!-- Tabs (only for groups with roles) -->
                  <div ng-if="isGroupConversation() && roleSuggestions.length > 0" class="mention-tabs">
                    <div 
                      ng-click="switchMentionTab('members')"
                      ng-class="{'active': mentionActiveTab === 'members'}"
                      class="mention-tab"
                    >
                      Members
                    </div>
                    <div 
                      ng-click="switchMentionTab('roles')"
                      ng-class="{'active': mentionActiveTab === 'roles'}"
                      class="mention-tab"
                    >
                      Roles
                    </div>
                  </div>
                  
                  <!-- Header (when no tabs) -->
                  <div ng-if="!isGroupConversation() || roleSuggestions.length === 0" class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                    {{ isGroupConversation() ? 'Members' : 'Contacts' }}
                  </div>
                  
                  <!-- Content -->
                  <div class="mention-suggestions-content" style="max-height: 300px; overflow-y: auto;">
                    <!-- Member Suggestions -->
                    <div ng-if="mentionActiveTab === 'members'">
                      <div
                        ng-repeat="user in memberSuggestions track by user.email"
                        ng-click="selectMention(user); $event.stopPropagation();"
                        ng-mouseenter="selectedMentionIndex = $index"
                        ng-mouseleave="selectedMentionIndex = -1"
                        ng-class="{'selected': $index === selectedMentionIndex}"
                        class="flex items-center gap-3 px-3 py-2 cursor-pointer mention-suggestion-item"
                        style="min-height: 48px;"
                      >
                        <img
                          ng-src="{{ getProfilePicture(user.profile_picture) }}"
                          auth-image="{{ getProfilePicture(user.profile_picture) }}"
                          alt="{{ user.username }}"
                          class="w-8 h-8 rounded-full flex-shrink-0"
                        >
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-white truncate">{{ user.name }}</p>
                          <p class="text-xs text-gray-400 truncate">@{{ user.username }}</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Role Suggestions -->
                    <div ng-if="mentionActiveTab === 'roles'">
                      <div
                        ng-repeat="role in roleSuggestions track by role.name"
                        ng-click="selectMention(role); $event.stopPropagation();"
                        ng-mouseenter="selectedMentionIndex = $index"
                        ng-mouseleave="selectedMentionIndex = -1"
                        ng-class="{'selected': $index === selectedMentionIndex}"
                        class="flex items-center gap-3 px-3 py-2 cursor-pointer mention-suggestion-item role-mention-item"
                        style="min-height: 48px;"
                      >
                        <div class="role-color-dot" ng-style="{'background-color': role.color}"></div>
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-white truncate">{{ role.name }}</p>
                          <p class="text-xs text-gray-400 truncate">Role</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- No Results -->
                    <div ng-if="getCurrentMentionSuggestions().length === 0" class="px-3 py-6 text-center">
                      <p class="text-sm text-gray-400">No {{ mentionActiveTab }} found</p>
                    </div>
                  </div>
                </div>
                
                <textarea
                  ng-model="messageInput"
                  ng-change="onMessageInput()"
                  ng-keydown="onMessageKeyDown($event)"
                  ng-attr-placeholder="{{ filePreviews.length > 0 ? 'Press Enter to send your attachments...' : 'Type your message...' }}"
                  ng-readonly="filePreviews.length > 0"
                  class="w-full bg-transparent px-4 py-3 pr-12 focus:outline-none resize-none rounded-2xl flex-1 custom-scrollbar placeholder-gray-400"
                  style="color: var(--text-primary); min-height: 44px; max-height: 120px; line-height: 1.5;"
                  ng-class="{ 'cursor-not-allowed opacity-50': filePreviews.length > 0 }"
                  rows="1"
                ></textarea>
                
                <!-- Character Count Display (Discord-style, inside input container) -->
                <div 
                  ng-if="showCharacterCount"
                  class="absolute bottom-2 right-12 discord-character-count"
                  ng-class="characterCount > maxMessageLength ? 'text-red-400' : 'text-yellow-400'"
                  style="z-index: 10; pointer-events: none;"
                >
                  {{ maxMessageLength - characterCount }}
                </div>
                
                <!-- Emoji Button -->
                <button
                  type="button"
                  ng-click="toggleEmojiPicker()"
                  class="absolute right-3 w-8 h-8 flex items-center justify-center hover:bg-gray-700 rounded-lg transition-colors duration-200"
                  style="top: 50%; transform: translateY(-50%);"
                  title="Add emoji"
                >
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </button>
              </div>
              
              <!-- Send/Microphone Button -->
              <button
                ng-if="messageInput.trim() || filePreviews.length > 0"
                type="button"
                ng-click="filePreviews.length > 0 ? sendStagedFiles() : sendMessage()"
                ng-disabled="sendingMessage || uploadingFile"
                class="flex-shrink-0 w-10 h-10 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-full flex items-center justify-center transition-all duration-200 shadow-lg"
                style="background-color: var(--text-primary); color: var(--bg-primary);"
                ng-attr-title="{{ filePreviews.length > 0 ? 'Send attachments' : 'Send message' }}"
              >
                <svg ng-if="!sendingMessage && !uploadingFile" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <div ng-if="sendingMessage || uploadingFile" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--bg-primary); border-top-color: transparent;"></div>
              </button>
              
              <button
                ng-if="!messageInput.trim() && filePreviews.length === 0"
                type="button"
                class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 shadow-lg"
                style="background-color: var(--text-primary); color: var(--bg-primary);"
                title="Voice message"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
              </button>
            </form>
            
            <!-- Disabled Message Input for Imported Groups -->
            <div ng-if="selectedContact.isGroup && isImportedGroup(selectedContact)" class="flex items-center space-x-3 p-3 relative">
              <div class="flex-1 relative rounded-2xl border opacity-50 cursor-not-allowed" style="background-color: #000000; border-color: var(--border-color);">
                <div class="w-full px-4 py-3 text-gray-500 rounded-2xl flex items-center justify-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                  </svg>
                  <span class="text-sm">Message sending disabled for imported groups</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Options Menu (positioned at root level for proper display) -->
  <div 
    ng-if="messageOptionsMenu.show" 
    class="message-options-menu"
    ng-style="{ left: messageOptionsMenu.x + 'px', top: messageOptionsMenu.y + 'px' }"
    ng-click="$event.stopPropagation()"
  >
    <!-- Edit Message (only for own messages) -->
    <div ng-if="messageOptionsMenu.message.sender === currentUser.email && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" class="message-options-item" ng-click="editMessage(messageOptionsMenu.message)">
      <span>Edit Message</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
      </svg>
    </div>

    <!-- Reply -->
    <div ng-if="!selectedContact.isGroup || !isImportedGroup(selectedContact)" class="message-options-item" ng-click="replyToMessage(messageOptionsMenu.message); hideMessageOptions()">
      <span>Reply</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
      </svg>
    </div>

    <!-- Forward -->
    <div ng-if="!selectedContact.isGroup || !isImportedGroup(selectedContact)" class="message-options-item" ng-click="forwardMessage(messageOptionsMenu.message); hideMessageOptions()">
      <span>Forward</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6-6m6 6l-6 6"></path>
      </svg>
    </div>

    <div class="message-options-divider"></div>

    <!-- Copy Text -->
    <div class="message-options-item" ng-click="copyMessageText(messageOptionsMenu.message)">
      <span>Copy Text</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
      </svg>
    </div>

    <!-- Pin Message -->
    <div ng-if="!selectedContact.isGroup || !isImportedGroup(selectedContact)" class="message-options-item" ng-click="togglePinMessage(messageOptionsMenu.message)">
      <span ng-if="!messageOptionsMenu.message.pinned && !messageOptionsMenu.message.is_pinned">Pin Message</span>
      <span ng-if="messageOptionsMenu.message.pinned || messageOptionsMenu.message.is_pinned">Unpin Message</span>
      <svg class="message-options-icon" fill="currentColor" viewBox="0 0 24 24">
        <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
      </svg>
    </div>

    <div ng-if="messageOptionsMenu.message.sender === currentUser.email" class="message-options-divider"></div>

    <!-- Delete Message (only for own messages) -->
    <div ng-if="messageOptionsMenu.message.sender === currentUser.email && (!selectedContact.isGroup || !isImportedGroup(selectedContact))" class="message-options-item danger" ng-click="deleteMessage(messageOptionsMenu.message)">
      <span>Delete Message</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
    </div>

    <!-- Copy Message ID -->
    <div class="message-options-item" ng-click="copyMessageId(messageOptionsMenu.message)">
      <span>Copy Message ID</span>
      <svg class="message-options-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
      </svg>
    </div>
  </div>
</div>

  <!-- Image Lightbox -->
  <div ng-if="lightbox.show" class="image-lightbox" ng-click="closeLightbox()">
    <button class="lightbox-close" ng-click="closeLightbox()">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    
    <!-- Navigation arrows positioned at screen edges -->
    <button ng-if="lightbox.images.length > 1" class="lightbox-nav lightbox-nav-prev" ng-click="previousImage(); $event.stopPropagation()">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    
    <button ng-if="lightbox.images.length > 1" class="lightbox-nav lightbox-nav-next" ng-click="nextImage(); $event.stopPropagation()">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
    
    <div class="lightbox-content" ng-click="$event.stopPropagation()">
      <img ng-src="{{ lightbox.currentImage }}" class="lightbox-image" alt="Full size image">
    </div>
    
    <div ng-if="lightbox.images.length > 1" class="lightbox-counter">
      {{ lightbox.currentIndex + 1 }} / {{ lightbox.images.length }}
    </div>
  </div>

    <!-- MOBILE APP LAYOUT (Only visible on mobile) -->
    <div ng-if="isMobile" class="mobile-only" style="position: fixed; inset: 0; z-index: 9999; background-color: var(--bg-primary);">
      <!-- Mobile Top Bar (Hidden when in chat view) -->
      <div class="mobile-top-bar" ng-show="mobileView !== 'chat'">
        <div class="mobile-top-bar-left">
          <img src="/src/app/public/logo.png" alt="VibgyorChat" class="w-8 h-8">
          <span class="mobile-app-title">VibgyorChat</span>
        </div>
        <div class="mobile-top-bar-right">
          <div class="mobile-connection-status" ng-if="socketConnected">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span>Connected</span>
          </div>
          <div class="mobile-connection-status" ng-if="!socketConnected" style="color: #ef4444;">
            <div class="w-2 h-2 rounded-full bg-red-500"></div>
            <span>Offline</span>
          </div>
        </div>
      </div>

      <!-- Mobile Content Area -->
      <div class="mobile-content-area">
        <!-- Chats List View -->
        <div ng-if="mobileView === 'chats'" class="mobile-list-view">
          <div class="mobile-search-section">
            <input
              type="text"
              ng-model="searchQuery"
              ng-change="searchContacts()"
              placeholder="Search chats, users, or join groups..."
              class="w-full border rounded-xl px-4 py-3 placeholder-gray-400 focus:outline-none"
              style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary);"
            >
          </div>
          
          <div class="mobile-filter-tabs">
            <div class="flex space-x-1 rounded-lg p-1 relative overflow-hidden" style="background-color: #000000;">
              <!-- Animated background -->
              <div 
                class="absolute top-1 bottom-1 rounded-md transition-all duration-300 ease-in-out"
                style="background-color: var(--text-primary);"
                ng-style="{
                  'left': filter === 'all' ? '4px' : (filter === 'muted' ? 'calc(33.33% + 2px)' : 'calc(66.66% + 0px)'),
                  'width': 'calc(33.33% - 4px)'
                }"
              ></div>
              
              <button 
                ng-click="filterContacts('all')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="filter === 'all' ? 'text-black' : 'text-gray-400'"
              >
                All
              </button>
              <button 
                ng-click="filterContacts('muted')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="filter === 'muted' ? 'text-black' : 'text-gray-400'"
              >
                Muted
              </button>
              <button 
                ng-click="filterContacts('favorites')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="filter === 'favorites' ? 'text-black' : 'text-gray-400'"
              >
                Favorites
              </button>
            </div>
          </div>
          
          <div class="mobile-contacts-list">
            <!-- Archived Folder (only show when filter is 'all' and there are archived contacts) -->
            <div 
              ng-if="filter === 'all' && archivedContacts.length > 0"
              ng-click="toggleArchivedFolder()"
              class="mobile-archived-folder"
            >
              <div class="mobile-contact-content">
                <div class="mobile-archived-icon">
                  <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                  </svg>
                </div>
                <div class="mobile-contact-info">
                  <div class="mobile-contact-header">
                    <div class="mobile-contact-name">Archived</div>
                  </div>
                  <div class="mobile-contact-message">{{ archivedContacts.length }} {{ archivedContacts.length === 1 ? 'chat' : 'chats' }}</div>
                </div>
              </div>
              <div class="mobile-archived-chevron">
                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" ng-class="{'rotate-90': showArchivedFolder}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>

            <!-- Archived contacts (shown when folder is expanded) -->
            <div ng-if="showArchivedFolder && archivedContacts.length > 0" class="mobile-archived-items">
              <div ng-repeat="contact in archivedContacts" class="mobile-contact-card archived">
                <div class="mobile-contact-content" ng-click="selectContactMobile(contact)">
                  <img ng-src="{{ getProfilePicture(contact.profile_picture) }}" auth-image="{{ getProfilePicture(contact.profile_picture) }}" alt="{{ contact.name }}" class="mobile-contact-avatar">
                  <div class="mobile-contact-info">
                    <div class="mobile-contact-header">
                      <div class="mobile-contact-name">{{ contact.name || contact.username }}</div>
                      <div class="mobile-contact-time" ng-if="contact.lastMessageTime">{{ contact.lastMessageTime | discordTime }}</div>
                    </div>
                    <div class="mobile-contact-bottom">
                      <div class="mobile-contact-message">{{ contact.lastMessageContent || 'No messages yet' }}</div>
                      <div class="mobile-status-icons">
                        <!-- Pin icon -->
                        <svg ng-if="contact.pinned" class="mobile-status-icon pin-icon" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                          <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"/>
                        </svg>
                        <!-- Favorite icon -->
                        <svg ng-if="contact.is_favorited" class="mobile-status-icon favorite-icon" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <!-- Mute icon -->
                        <svg ng-if="contact.muted" class="mobile-status-icon mute-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Muted">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                        </svg>
                      </div>
                    </div>
                    <div ng-if="contact.unreadCount > 0" class="mobile-unread-badge">{{ contact.unreadCount }}</div>
                  </div>
                </div>
                <!-- Three-dot menu button (positioned lower) -->
                <button 
                  ng-click="showMobileContextMenu($event, contact)"
                  class="mobile-menu-button mobile-menu-button-lower"
                  title="More options"
                >
                  <div class="three-dots-container">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                  </div>
                </button>
              </div>
            </div>

            <div ng-repeat="contact in filteredContacts" class="mobile-contact-card">
              <div class="mobile-contact-content" ng-click="selectContactMobile(contact)">
                <img ng-src="{{ getProfilePicture(contact.profile_picture) }}" auth-image="{{ getProfilePicture(contact.profile_picture) }}" alt="{{ contact.name }}" class="mobile-contact-avatar">
                <div class="mobile-contact-info">
                  <div class="mobile-contact-header">
                    <div class="mobile-contact-name">{{ contact.name || contact.username }}</div>
                    <div class="mobile-contact-time" ng-if="contact.lastMessageTime">{{ contact.lastMessageTime | discordTime }}</div>
                  </div>
                  <div class="mobile-contact-bottom">
                    <div class="mobile-contact-message">{{ contact.lastMessageContent || 'No messages yet' }}</div>
                    <div class="mobile-status-icons">
                      <!-- Pin icon -->
                      <svg ng-if="contact.pinned" class="mobile-status-icon pin-icon" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                        <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"/>
                      </svg>
                      <!-- Favorite icon -->
                      <svg ng-if="contact.is_favorited" class="mobile-status-icon favorite-icon" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                        <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                      </svg>
                      <!-- Mute icon -->
                      <svg ng-if="contact.muted" class="mobile-status-icon mute-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Muted">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                      </svg>
                    </div>
                  </div>
                  <div ng-if="contact.unreadCount > 0" class="mobile-unread-badge">{{ contact.unreadCount }}</div>
                </div>
              </div>
              <!-- Three-dot menu button (positioned lower) -->
              <button 
                ng-click="showMobileContextMenu($event, contact)"
                class="mobile-menu-button mobile-menu-button-lower"
                title="More options"
              >
                <div class="three-dots-container">
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Groups List View -->
        <div ng-if="mobileView === 'groups'" class="mobile-list-view">
          <div class="mobile-search-section">
            <input
              type="text"
              placeholder="Search chats, users, or join groups..."
              class="w-full border rounded-xl px-4 py-3 placeholder-gray-400 focus:outline-none"
              style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary);"
            >
          </div>
          
          <div class="mobile-filter-tabs">
            <div class="flex space-x-1 rounded-lg p-1 relative overflow-hidden" style="background-color: #000000;">
              <!-- Animated background -->
              <div 
                class="absolute top-1 bottom-1 rounded-md transition-all duration-300 ease-in-out"
                style="background-color: var(--text-primary);"
                ng-style="{
                  'left': groupFilter === 'all' ? '4px' : (groupFilter === 'muted' ? 'calc(33.33% + 2px)' : 'calc(66.66% + 0px)'),
                  'width': 'calc(33.33% - 4px)'
                }"
              ></div>
              
              <button 
                ng-click="filterGroups('all')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="groupFilter === 'all' ? 'text-black' : 'text-gray-400'"
              >
                All
              </button>
              <button 
                ng-click="filterGroups('muted')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="groupFilter === 'muted' ? 'text-black' : 'text-gray-400'"
              >
                Muted
              </button>
              <button 
                ng-click="filterGroups('favorites')" 
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors duration-200 relative z-10"
                ng-class="groupFilter === 'favorites' ? 'text-black' : 'text-gray-400'"
              >
                Favorites
              </button>
            </div>
          </div>
          
          <div class="mobile-contacts-list">
            <!-- Archived Folder (only show when filter is 'all' and there are archived groups) -->
            <div 
              ng-if="groupFilter === 'all' && archivedGroups.length > 0"
              ng-click="toggleArchivedFolder()"
              class="mobile-archived-folder"
            >
              <div class="mobile-contact-content">
                <div class="mobile-archived-icon">
                  <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                  </svg>
                </div>
                <div class="mobile-contact-info">
                  <div class="mobile-contact-header">
                    <div class="mobile-contact-name">Archived</div>
                  </div>
                  <div class="mobile-contact-message">{{ archivedGroups.length }} {{ archivedGroups.length === 1 ? 'group' : 'groups' }}</div>
                </div>
              </div>
              <div class="mobile-archived-chevron">
                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" ng-class="{'rotate-90': showArchivedFolder}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>

            <!-- Archived groups (shown when folder is expanded) -->
            <div ng-if="showArchivedFolder && archivedGroups.length > 0" class="mobile-archived-items">
              <div ng-repeat="group in archivedGroups" class="mobile-contact-card archived">
                <div class="mobile-contact-content" ng-click="selectGroupMobile(group)">
                  <img ng-src="{{ getGroupPicture(group) }}" auth-image="{{ getGroupPicture(group) }}" alt="{{ group.name }}" class="mobile-contact-avatar">
                  <div class="mobile-contact-info">
                    <div class="mobile-contact-header">
                      <div class="mobile-contact-name">{{ group.name }}</div>
                      <div class="mobile-contact-time" ng-if="group.lastMessageTime">{{ group.lastMessageTime | discordTime }}</div>
                    </div>
                    <div class="mobile-contact-bottom">
                      <div class="mobile-contact-message">{{ group.lastMessageContent || 'No messages yet' }}</div>
                      <div class="mobile-status-icons">
                        <!-- Pin icon -->
                        <svg ng-if="group.pinned" class="mobile-status-icon pin-icon" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                          <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"/>
                        </svg>
                        <!-- Favorite icon -->
                        <svg ng-if="group.is_favorited" class="mobile-status-icon favorite-icon" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <!-- Mute icon -->
                        <svg ng-if="group.muted" class="mobile-status-icon mute-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Muted">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Three-dot menu button (positioned lower) -->
                <button 
                  ng-click="showMobileContextMenu($event, group)"
                  class="mobile-menu-button mobile-menu-button-lower"
                  title="More options"
                >
                  <div class="three-dots-container">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                  </div>
                </button>
              </div>
            </div>

            <!-- Regular groups (non-archived) -->
            <div ng-repeat="group in filteredGroups" class="mobile-contact-card">
              <div class="mobile-contact-content" ng-click="selectGroupMobile(group)">
                <img ng-src="{{ getGroupPicture(group) }}" auth-image="{{ getGroupPicture(group) }}" alt="{{ group.name }}" class="mobile-contact-avatar">
                <div class="mobile-contact-info">
                  <div class="mobile-contact-header">
                    <div class="mobile-contact-name">{{ group.name }}</div>
                    <div class="mobile-contact-time" ng-if="group.lastMessageTime">{{ group.lastMessageTime | discordTime }}</div>
                  </div>
                  <div class="mobile-contact-bottom">
                    <div class="mobile-contact-message">{{ group.lastMessageContent || 'No messages yet' }}</div>
                    <div class="mobile-status-icons">
                      <!-- Pin icon -->
                      <svg ng-if="group.pinned" class="mobile-status-icon pin-icon" fill="currentColor" viewBox="0 0 24 24" title="Pinned">
                        <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"/>
                      </svg>
                      <!-- Favorite icon -->
                      <svg ng-if="group.is_favorited" class="mobile-status-icon favorite-icon" fill="currentColor" viewBox="0 0 24 24" title="Favorite">
                        <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                      </svg>
                      <!-- Mute icon -->
                      <svg ng-if="group.muted" class="mobile-status-icon mute-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Muted">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Three-dot menu button (positioned lower) -->
              <button 
                ng-click="showMobileContextMenu($event, group)"
                class="mobile-menu-button mobile-menu-button-lower"
                title="More options"
              >
                <div class="three-dots-container">
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Floating Action Button for Create Group (Mobile Groups View Only) -->
        <button 
          ng-if="mobileView === 'groups'" 
          ng-click="showCreateGroupModal()" 
          class="fixed bottom-20 right-4 w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center z-50 hover:bg-gray-100 transition-colors duration-200"
          style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);"
        >
          <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
        </button>

        <!-- Mobile Chat View - Complete Redesign -->
        <div ng-if="mobileView === 'chat' && selectedContact" class="mobile-chat-view-container">
          
          <!-- Mobile Chat Header -->
          <div class="mobile-chat-header-new">
            <div class="flex items-center justify-between w-full">
              <!-- Left: Back button + Contact Info -->
              <div class="flex items-center space-x-3 flex-1 min-w-0">
                <button ng-click="backToList()" class="mobile-back-btn">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                
                <!-- Profile Picture -->
                <img
                  ng-if="!selectedContact.isGroup"
                  ng-src="{{ getProfilePicture(selectedContact.profile_picture) }}"
                  auth-image="{{ getProfilePicture(selectedContact.profile_picture) }}"
                  alt="{{ selectedContact.username }}"
                  class="w-10 h-10 rounded-full ring-2 ring-gray-600"
                >
                <img
                  ng-if="selectedContact.isGroup"
                  ng-src="{{ getGroupPicture(selectedContact) }}"
                  alt="{{ selectedContact.name }}"
                  class="w-10 h-10 rounded-full ring-2 ring-gray-600"
                >
                
                <!-- Contact Info -->
                <div class="flex-1 min-w-0">
                  <h2 class="text-base font-semibold text-white truncate">
                    {{ selectedContact.name || selectedContact.username }}
                  </h2>
                  <!-- Pill-shaped status for contacts (like desktop) -->
                  <div ng-if="!selectedContact.isGroup" class="flex items-center space-x-2 backdrop-blur-sm rounded-full px-2 py-1 border mt-1" style="background-color: #000000; border-color: var(--border-color); width: fit-content;">
                    <div 
                      class="w-2 h-2 rounded-full"
                      ng-class="{
                        'bg-green-500 animate-pulse-soft': selectedContact.online && !selectedContact.idle,
                        'bg-yellow-500 animate-pulse-soft': selectedContact.idle,
                        'bg-gray-500': !selectedContact.online && !selectedContact.idle
                      }"
                    ></div>
                    <span 
                      class="text-xs font-medium"
                      ng-class="{
                        'text-green-400': selectedContact.online && !selectedContact.idle,
                        'text-yellow-400': selectedContact.idle,
                        'text-gray-400': !selectedContact.online && !selectedContact.idle
                      }"
                    >
                      <span ng-if="selectedContact.online && !selectedContact.idle">Online</span>
                      <span ng-if="selectedContact.idle">Idle</span>
                      <span ng-if="!selectedContact.online && !selectedContact.idle">Offline</span>
                    </span>
                  </div>
                  <!-- Group member count -->
                  <div ng-if="selectedContact.isGroup" class="text-xs text-gray-400 mt-1">
                    {{ selectedContact.members_count }} member{{ selectedContact.members_count !== 1 ? 's' : '' }}
                  </div>
                </div>
              </div>

              <!-- Right: Action buttons -->
              <div class="flex items-center space-x-1">
                <button ng-click="startVoiceCall()" class="mobile-header-btn" title="Voice call">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                </button>
                <button ng-click="startVideoCall()" class="mobile-header-btn" title="Video call">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
                <button ng-click="togglePinnedMessagesPopup()" class="mobile-header-btn relative" title="Pinned Messages">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                  </svg>
                  <span ng-if="hasUnviewedPinnedMessages" class="absolute -top-1 -right-1 bg-red-500 rounded-full w-3 h-3"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Mobile Pinned Messages Popup -->
          <div ng-if="showPinnedMessagesPopup" class="mobile-pinned-popup">
            <div class="mobile-pinned-header">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <h3 class="text-base font-semibold text-white">Pinned Messages</h3>
              </div>
              <button ng-click="togglePinnedMessagesPopup()" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="mobile-pinned-content">
              <!-- No pinned messages -->
              <div ng-if="pinnedMessages.length === 0" class="text-center py-8">
                <svg class="w-12 h-12 text-gray-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                </svg>
                <p class="text-gray-400 text-sm">No pinned messages</p>
              </div>

              <!-- Pinned messages list -->
              <div ng-repeat="message in pinnedMessages" class="mobile-pinned-item" ng-click="scrollToMessage(message); togglePinnedMessagesPopup()">
                <div class="flex items-start space-x-3">
                  <img
                    ng-src="{{ getMessageSenderAvatar(message) }}"
                    auth-image="{{ getMessageSenderAvatar(message) }}"
                    alt="{{ getMessageSenderName(message) }}"
                    class="w-10 h-10 rounded-full flex-shrink-0"
                  >
                  <div class="flex-1 min-w-0">
                    <div class="flex items-baseline space-x-2 mb-1">
                      <span class="font-semibold text-white text-sm">{{ getMessageSenderName(message) }}</span>
                      <span class="text-xs text-gray-400">{{ message.created_at | discordTime }}</span>
                    </div>
                    <div class="message-content">
                      <p ng-if="message.content && message.type === 'text'" class="text-gray-100 leading-relaxed whitespace-pre-wrap line-clamp-2">{{ message.content }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Imported Group Warning Banner -->
          <div ng-if="selectedContact.isGroup && isImportedGroup(selectedContact)" class="mobile-warning-banner">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div class="flex-1">
                <p class="text-sm font-medium text-yellow-400"> Imported Group</p>
                <p class="text-xs text-yellow-300 mt-0.5">{{ selectedContact.original_message_count }} messages from backup - read only</p>
              </div>
            </div>
          </div>

          <!-- Messages Area -->
          <div class="mobile-messages-container">
            <!-- Loading messages indicator -->
            <div ng-if="loadingMessages" class="flex flex-col items-center justify-center py-12">
              <div class="animate-spin w-8 h-8 border-2 border-t-transparent rounded-full mb-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
              <p class="text-gray-400">Loading messages...</p>
            </div>

            <!-- Messages List -->
            <div 
              id="mobile-messages-container"
              class="mobile-messages-list"
              mobile-scroll
            >
              <!-- Loading older messages indicator -->
              <div ng-if="loadingOlderMessages" class="text-center py-4">
                <div class="animate-spin w-6 h-6 border-2 border-t-transparent rounded-full mx-auto mb-2" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
                <p class="text-gray-400 text-sm">Loading older messages...</p>
              </div>

              <!-- No more messages indicator (beginning of conversation) -->
              <div ng-if="!loadingOlderMessages && messages.length > 0 && !ChatService.hasMoreMessages" class="text-center py-4">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-2">
                  <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <p class="text-gray-500 text-xs">You've reached the beginning of this conversation</p>
              </div>
              <div
                ng-repeat="message in messages track by (message.id || message._id)"
                ng-if="!shouldHideMessageInImportedGroup(message)"
                class="mobile-message-item"
                id="message-{{ message.id }}"
              >
                <!-- Date Divider -->
                <div ng-if="shouldShowDateDivider(message, messages[$index - 1])" class="mobile-date-separator">
                  <div class="mobile-date-line"></div>
                  <span class="mobile-date-text">{{ formatDateDivider(message.created_at) }}</span>
                  <div class="mobile-date-line"></div>
                </div>

                <!-- Message Content -->
                <div 
                  class="mobile-message-content" 
                  ng-class="[shouldShowMessageHeader(message, messages[$index - 1], $index) ? 'mobile-message-with-header' : 'mobile-message-continuation']"
                  data-message-id="{{ message.id }}"
                  mobile-swipe-reply="message"
                >
                  
                  <!-- Message with Header -->
                  <div ng-if="shouldShowMessageHeader(message, messages[$index - 1], $index)" class="flex space-x-3">
                    <!-- Avatar -->
                    <div class="flex-shrink-0">
                      <img
                        ng-src="{{ getMessageSenderAvatar(message) }}"
                        auth-image="{{ getMessageSenderAvatar(message) }}"
                        alt="{{ getMessageSenderName(message) }}"
                        class="w-10 h-10 rounded-full"
                      >
                    </div>
                    
                    <!-- Message Body -->
                    <div class="flex-1 min-w-0">
                      <!-- Header: Name + Time -->
                      <div class="flex items-baseline space-x-2 mb-1">
                        <span class="font-semibold text-white text-sm">
                          {{ getMessageSenderName(message) }}
                        </span>
                        <span class="text-xs text-gray-400">
                          {{ message.created_at | discordTime }}
                        </span>
                        <span ng-if="message.pinned" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-yellow-500/20 text-yellow-400">
                          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7.084 11.457C5.782 12.325 5 12.709 5 14.274V15h7v7l.5 1 .5-1v-7h7v-.726c0-1.565-.782-1.95-2.084-2.817l-1.147-.765L15 4l1.522-.43A2.029 2.029 0 0 0 18 1.619V1H7v.618A2.029 2.029 0 0 0 8.478 3.57L10 4l-1.77 6.692zM16.93 12l.73.485c1 .659 1.28.866 1.332 1.515H6.009c.051-.65.332-.856 1.333-1.515L8.07 12zM8.75 2.608A1.033 1.033 0 0 1 8.075 2h8.852a1.033 1.033 0 0 1-.676.608L14.862 3h-4.724zM11.035 4h2.931l1.85 7h-6.63z"></path>
                          </svg>
                          Pinned
                        </span>
                      </div>

                      <!-- Message Text -->
                      <div class="mobile-message-text">
                        <p ng-if="message.deleted || message.is_deleted" class="text-gray-500 italic text-sm">This message was deleted</p>
                        <p ng-if="!message.deleted && !message.is_deleted && message.content" class="text-gray-100 leading-relaxed whitespace-pre-wrap">{{ message.content }}</p>
                      </div>

                      <!-- Image Attachment -->
                      <div ng-if="isImageMessage(message) && message.file_data" class="mt-2">
                        <img 
                          ng-src="data:image/jpeg;base64,{{ message.file_data }}" 
                          alt="Image"
                          class="max-w-full h-auto max-h-64 rounded-lg cursor-pointer"
                          ng-click="downloadFile(message)"
                        >
                      </div>

                      <!-- File Attachment -->
                      <div ng-if="isFileMessage(message)" class="mt-2">
                        <div class="mobile-file-item" ng-click="downloadFile(message)">
                          <div class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="flex-1 min-w-0">
                              <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                              <p class="text-xs text-gray-400">{{ formatFileSize(message.file_size) }}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Message Continuation (no header) -->
                  <div ng-if="!shouldShowMessageHeader(message, messages[$index - 1], $index)" class="flex space-x-3">
                    <!-- Empty space for avatar alignment -->
                    <div class="flex-shrink-0 w-10"></div>
                    
                    <!-- Message Body -->
                    <div class="flex-1 min-w-0">
                      <!-- Message Text -->
                      <div class="mobile-message-text">
                        <p ng-if="message.deleted || message.is_deleted" class="text-gray-500 italic text-sm">This message was deleted</p>
                        <p ng-if="!message.deleted && !message.is_deleted && message.content" class="text-gray-100 leading-relaxed whitespace-pre-wrap">{{ message.content }}</p>
                      </div>

                      <!-- Attachments (same as above) -->
                      <div ng-if="isImageMessage(message) && message.file_data" class="mt-2">
                        <img 
                          ng-src="data:image/jpeg;base64,{{ message.file_data }}" 
                          alt="Image"
                          class="max-w-full h-auto max-h-64 rounded-lg cursor-pointer"
                          ng-click="downloadFile(message)"
                        >
                      </div>

                      <div ng-if="isFileMessage(message)" class="mt-2">
                        <div class="mobile-file-item" ng-click="downloadFile(message)">
                          <div class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="flex-1 min-w-0">
                              <p class="text-sm font-medium text-white truncate">{{ message.file_name }}</p>
                              <p class="text-xs text-gray-400">{{ formatFileSize(message.file_size) }}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Typing Indicator -->
              <div ng-if="typingUsers.length > 0" class="mobile-typing-indicator">
                <div class="flex space-x-3 px-4 py-2">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                    <div class="flex space-x-1">
                      <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                      <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                      <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                  </div>
                  <div class="flex-1 pt-2">
                    <p class="text-sm text-gray-400 italic">
                      <span ng-if="typingUsers.length === 1">{{ typingUsers[0] }} is typing...</span>
                      <span ng-if="typingUsers.length === 2">{{ typingUsers[0] }} and {{ typingUsers[1] }} are typing...</span>
                      <span ng-if="typingUsers.length > 2">{{ typingUsers.length }} people are typing...</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile Jump to Present Button -->
          <div 
            ng-if="showMobileJumpToPresent" 
            class="mobile-jump-to-present-container"
            ng-style="{'opacity': mobileJumpToPresentLoaded ? '1' : '0'}"
          >
            <div class="mobile-jump-to-present-wrapper">
              <span class="mobile-jump-to-present-text">You're Viewing Older Messages</span>
              <button
                ng-click="jumpToPresentMobile()"
                class="mobile-jump-to-present-button"
              >
                Jump To Present
              </button>
            </div>
          </div>

          <!-- Message Input Area -->
          <div class="mobile-input-area" ng-if="!selectedContact.isGroup || !isImportedGroup(selectedContact)">
            <!-- Reply Preview -->
            <div ng-if="replyingTo" class="mobile-reply-preview">
              <div class="mobile-reply-content">
                <div class="mobile-reply-header">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                  </svg>
                  <span class="mobile-reply-to">Replying to {{ replyingTo.senderName }}</span>
                </div>
                <div class="mobile-reply-message">{{ replyingTo.content | limitTo:50 }}{{ replyingTo.content.length > 50 ? '...' : '' }}</div>
              </div>
              <button type="button" ng-click="cancelReply()" class="mobile-reply-cancel">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="mobile-input-container">
              <!-- Plus Button (Attachment) -->
              <button 
                type="button" 
                ng-click="toggleAttachmentMenu()" 
                class="mobile-plus-btn"
                ng-disabled="uploadingFile"
              >
                <svg ng-if="!uploadingFile" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <div ng-if="uploadingFile" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--bg-primary); border-top-color: transparent;"></div>
              </button>

              <!-- Message Input Field Container -->
              <div class="mobile-input-field-container">
                <textarea
                  ng-model="messageInput"
                  ng-change="onMessageInput()"
                  ng-keydown="onMessageKeyDown($event)"
                  placeholder="Type your message..."
                  class="mobile-input-field-new"
                  rows="1"
                ></textarea>
                
                <!-- Emoji Button (inside input) -->
                <button
                  type="button"
                  ng-click="toggleEmojiPicker()"
                  class="mobile-emoji-btn-inside"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </button>
              </div>

              <!-- Send/Mic Button -->
              <button
                ng-if="messageInput.trim()"
                type="button"
                ng-click="sendMessage()"
                ng-disabled="sendingMessage"
                class="mobile-send-btn"
              >
                <svg ng-if="!sendingMessage" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <div ng-if="sendingMessage" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--bg-primary); border-top-color: transparent;"></div>
              </button>
              
              <button
                ng-if="!messageInput.trim()"
                type="button"
                class="mobile-mic-btn"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
              </button>
            </div>

            <!-- Mobile Attachment Menu -->
            <div ng-if="showAttachmentMenu" class="mobile-attachment-menu">
              <div class="mobile-attachment-item" ng-click="selectImage(); toggleAttachmentMenu()">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>Photo</span>
              </div>
              <div class="mobile-attachment-item" ng-click="selectFile(); toggleAttachmentMenu()">
                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>File</span>
              </div>
            </div>

            <!-- Mobile Emoji Picker -->
            <div ng-if="showEmojiPicker" class="mobile-emoji-picker">
              <div class="mobile-emoji-header">
                <span class="text-sm font-medium text-white">Emoji</span>
                <button ng-click="toggleEmojiPicker()" class="text-gray-400 hover:text-white">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div class="mobile-emoji-grid">
                <button ng-repeat="emoji in ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']" 
                        ng-click="insertEmoji(emoji); toggleEmojiPicker()" 
                        class="mobile-emoji-btn">
                  {{ emoji }}
                </button>
              </div>
            </div>
          </div>
          
          <!-- Disabled Input for Imported Groups -->
          <div class="mobile-input-area" ng-if="selectedContact.isGroup && isImportedGroup(selectedContact)">
            <div class="mobile-input-disabled">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
              </svg>
              <span class="text-sm text-gray-500">Message sending disabled</span>
            </div>
          </div>
        </div>

        <!-- Settings View -->
        <div ng-if="mobileView === 'settings'" class="mobile-list-view">
          <!-- Settings Content (Scrollable) -->
          <div class="mobile-settings-scrollable">
            <div class="p-4 sm:p-6">
              <h3 class="text-lg sm:text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                App Settings
              </h3>
              
              <!-- Theme Setting -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Theme</label>
                <div class="relative">
                  <div class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between opacity-75 cursor-not-allowed" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                    <div class="flex items-center">
                      <!-- Dark theme icon -->
                      <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                      </svg>
                      <span>Dark</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15l3-3H9l3 3z"></path>
                    </svg>
                  </div>
                  
                  <!-- Development Notice -->
                  <div class="mt-2 text-xs text-gray-400 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Light theme is currently in development
                  </div>
                </div>
              </div>
              
              <!-- Group Chat Backup Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                  </svg>
                  Group Chat Backup
                </h4>
                
                <!-- Export Group Chat -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Export Group Chat</label>
                  <div class="relative">
                    <button
                      ng-click="toggleBackupDropdown(); $event.stopPropagation()"
                      ng-disabled="getAdminGroups().length === 0"
                      class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                      style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                    >
                      <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span ng-if="getAdminGroups().length > 0">Select group to export</span>
                        <span ng-if="getAdminGroups().length === 0" class="text-gray-500">No groups available for export</span>
                      </div>
                      <svg ng-if="getAdminGroups().length > 0" class="w-4 h-4 text-gray-400 transition-transform duration-200" ng-class="{'rotate-180': backupDropdownOpen}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                    
                    <!-- Export Dropdown -->
                    <div ng-if="backupDropdownOpen && getAdminGroups().length > 0" ng-click="$event.stopPropagation()" class="absolute top-full left-0 right-0 mt-1 rounded-lg border shadow-lg z-20 max-h-48 overflow-y-auto" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                      <div 
                        ng-repeat="group in getAdminGroups()"
                        ng-click="exportGroupChat(group)"
                        class="px-4 py-3 hover:bg-gray-700 cursor-pointer transition-colors duration-200 flex items-center"
                        ng-class="{'opacity-50 cursor-not-allowed': exportingGroup && selectedGroupForBackup.id !== group.id}"
                      >
                        <img
                          ng-src="{{ getGroupPicture(group) }}"
                          alt="{{ group.name }}"
                          class="w-8 h-8 rounded-full mr-3 flex-shrink-0"
                        >
                        <div class="flex-1 min-w-0">
                          <div class="text-white font-medium truncate">{{ group.name }}</div>
                          <div class="text-xs text-gray-400">{{ group.members_count }} members</div>
                        </div>
                        <div ng-if="exportingGroup && selectedGroupForBackup.id === group.id" class="ml-2">
                          <div class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
                        </div>
                        <svg ng-if="group.owner === currentUser.email" class="w-4 h-4 text-yellow-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Owner">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z"></path>
                        </svg>
                        <svg ng-if="group.owner !== currentUser.email" class="w-4 h-4 text-blue-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Admin">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 text-xs text-gray-500">
                    Only group owners and admins can export chat history
                  </div>
                </div>
                
                <!-- Import Group Chat -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Import Group Chat</label>
                  <button
                    ng-click="triggerImportFile()"
                    ng-disabled="importingGroup"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-center focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <svg ng-if="!importingGroup" class="w-4 h-4 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <div ng-if="importingGroup" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full mr-3" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
                    <span ng-if="!importingGroup">Choose CSV file to import</span>
                    <span ng-if="importingGroup">Importing...</span>
                  </button>
                  
                  <!-- Hidden file input -->
                  <input 
                    type="file" 
                    id="importCsvFile" 
                    accept=".csv,text/csv" 
                    style="display: none;" 
                    onchange="angular.element(this).scope().onImportFileSelected(event)"
                  >
                  
                  <div class="mt-2 text-xs text-gray-500">
                    Upload a CSV file containing chat history to import
                  </div>
                </div>
              </div>
              
              <!-- Notification Audio Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M8.464 8.464a5 5 0 000 7.072M5.636 5.636a9 9 0 000 12.728M12 12h.01"></path>
                  </svg>
                  Notifications & Sounds
                </h4>
                
                <!-- Browser Notifications -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Browser Notifications</label>
                  <button
                    ng-click="checkAndRequestNotificationPermission()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.868 19.718A10.968 10.968 0 016.75 19h2.5A10.968 10.968 0 0112 20.25c1.357 0 2.637-.247 3.868-.682M4.868 19.718A10.968 10.968 0 013 12c0-1.357.247-2.637.682-3.868M4.868 19.718L12 12.75l7.132 6.968M20.25 12c0 1.357-.247 2.637-.682 3.868M20.25 12L12 4.25 3.75 12"></path>
                      </svg>
                      <span>Enable Browser Notifications</span>
                    </div>
                    <div class="flex items-center">
                      <div 
                        ng-if="notificationPermission === 'granted'"
                        class="w-2 h-2 bg-green-500 rounded-full mr-2"
                      ></div>
                      <div 
                        ng-if="notificationPermission === 'denied'"
                        class="w-2 h-2 bg-red-500 rounded-full mr-2"
                      ></div>
                      <div 
                        ng-if="notificationPermission === 'default'"
                        class="w-2 h-2 bg-yellow-500 rounded-full mr-2"
                      ></div>
                      <span class="text-xs text-gray-400">
                        {{ notificationPermission === 'granted' ? 'Enabled' : 
                           notificationPermission === 'denied' ? 'Blocked' : 'Not Set' }}
                      </span>
                    </div>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    <span ng-if="notificationPermission === 'granted'"> You'll receive desktop notifications for new messages</span>
                    <span ng-if="notificationPermission === 'denied'"> Notifications are blocked. Enable them in your browser settings.</span>
                    <span ng-if="notificationPermission === 'default'"> Click to enable desktop notifications for new messages</span>
                  </div>
                </div>
                
                <!-- Enable Audio Button -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Audio Notifications</label>
                  <button
                    ng-click="enableAudioWithUserInteraction()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-center focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <svg class="w-4 h-4 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M8.464 8.464a5 5 0 000 7.072M5.636 5.636a9 9 0 000 12.728M12 12h.01"></path>
                    </svg>
                    <span>Enable Notification Sounds</span>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    Click to enable audio notifications (required by browser security)
                  </div>
                </div>
              </div>
              
              <!-- Privacy & Safety Section -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <h4 class="text-sm font-medium text-gray-300 mb-4 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                  Privacy & Safety
                </h4>
                
                <!-- Blocked Users Button -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-400 mb-2">Blocked Users</label>
                  <button
                    ng-click="openBlockedUsersModal()"
                    class="w-full px-4 py-3 rounded-lg border text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200 hover:bg-gray-700"
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                  >
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                      </svg>
                      <span>Manage Blocked Users</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                  <div class="mt-2 text-xs text-gray-500">
                    View and manage users you have blocked
                  </div>
                </div>
              </div>
              
              <!-- Logout Button -->
              <div class="border-t pt-6" style="border-color: var(--border-color);">
                <button ng-click="logout()" class="w-full p-4 bg-red-600 hover:bg-red-700 rounded-lg text-left text-white transition-colors duration-200 flex items-center justify-center">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                  </svg>
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Bottom Navigation (Hidden when in chat view) -->
      <div class="mobile-bottom-nav" ng-show="mobileView !== 'chat'">
        <div ng-click="setMobileView('chats')" class="mobile-nav-item" ng-class="{'active': mobileView === 'chats'}">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <span>Chats</span>
        </div>
        <div ng-click="setMobileView('groups')" class="mobile-nav-item" ng-class="{'active': mobileView === 'groups'}">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <span>Groups</span>
        </div>
        <div ng-click="setMobileView('settings')" class="mobile-nav-item" ng-class="{'active': mobileView === 'settings'}">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>Settings</span>
        </div>
        <div ng-click="showProfilePopup = true" class="mobile-nav-item mobile-nav-profile">
          <div class="mobile-nav-profile-picture">
            <img ng-src="{{ getProfilePicture(currentUser.profile_picture) }}" auth-image="{{ getProfilePicture(currentUser.profile_picture) }}" alt="Profile" class="w-full h-full object-cover rounded-full">
          </div>
          <span>Profile</span>
        </div>
      </div>
    </div>

  <!-- User Profile Popup (Discord-style) - Positioned near clicked name -->
  <div 
    ng-if="userProfilePopup.show" 
    class="fixed z-[9999]"
    ng-style="{ left: userProfilePopup.x + 'px', top: userProfilePopup.y + 'px' }"
    ng-click="$event.stopPropagation()"
  >
    <!-- Backdrop to close on click outside -->
    <div class="fixed inset-0 -z-10" ng-click="closeUserProfilePopup()"></div>
    
    <!-- Profile Card -->
    <div 
      class="rounded-lg shadow-2xl overflow-hidden border"
      style="width: 300px; background-color: var(--bg-secondary); border-color: var(--border-color);"
    >
      <!-- Banner (Black/White based on theme) -->
      <div class="relative h-16" style="background-color: var(--bg-primary);">
        <!-- Three dots menu button (only for other users) -->
        <button
          ng-if="!userProfilePopup.isCurrentUser"
          ng-click="toggleUserProfileMenu($event)"
          class="absolute top-2 right-2 w-7 h-7 rounded-full flex items-center justify-center transition-colors"
          style="background-color: rgba(0, 0, 0, 0.3);"
        >
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div 
          ng-if="userProfilePopup.showMenu"
          class="absolute top-10 right-2 rounded-lg border shadow-xl py-2 min-w-40 z-10"
          style="background-color: var(--bg-primary); border-color: var(--border-color);"
          ng-click="$event.stopPropagation()"
        >
          <button
            ng-click="goToUserChat()"
            class="w-full px-3 py-2 text-left text-sm hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2"
            style="color: var(--text-primary);"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <span>Go to Chat</span>
          </button>
          
          <div class="h-px my-1" style="background-color: var(--border-color);"></div>
          
          <button
            ng-click="blockUserFromPopup()"
            class="w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>
            <span>Block User</span>
          </button>
        </div>
      </div>
      
      <!-- Profile Picture with Status Dot -->
      <div class="relative px-4 pb-3">
        <div class="relative -mt-10 mb-3">
          <div class="relative inline-block">
            <img
              ng-src="{{ getProfilePicture(userProfilePopup.user.profile_picture) }}"
              auth-image="{{ getProfilePicture(userProfilePopup.user.profile_picture) }}"
              alt="{{ userProfilePopup.user.name }}"
              class="w-16 h-16 rounded-full ring-4 ring-white"
            >
            <!-- Status Dot -->
            <div 
              class="absolute bottom-0 right-0 w-5 h-5 rounded-full border-4 border-white"
              ng-class="{
                'bg-green-500': userProfilePopup.user.online && !userProfilePopup.user.idle,
                'bg-yellow-500': userProfilePopup.user.idle,
                'bg-gray-500': !userProfilePopup.user.online && !userProfilePopup.user.idle
              }"
            ></div>
          </div>
        </div>
        
        <!-- User Info -->
        <div class="mb-3">
          <h3 class="text-lg font-bold text-white mb-0.5">
            {{ userProfilePopup.user.name || userProfilePopup.user.username }}
          </h3>
          <p class="text-sm text-gray-400">
            @{{ userProfilePopup.user.username }}
          </p>
        </div>
        
        <!-- Add to Contacts Button (only for other users) -->
        <button
          ng-if="!userProfilePopup.isCurrentUser && !isUserInContacts(userProfilePopup.user.email)"
          ng-click="addUserToContacts()"
          class="w-full px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center space-x-2"
          style="background-color: var(--text-primary); color: var(--bg-primary);"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
          </svg>
          <span>Add to Contacts</span>
        </button>
        
        <!-- Already in Contacts (only for other users) -->
        <div
          ng-if="!userProfilePopup.isCurrentUser && isUserInContacts(userProfilePopup.user.email)"
          class="w-full px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-center space-x-2"
          style="background-color: var(--bg-primary); color: var(--text-secondary);"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span>Already in Contacts</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Blocked Users Modal -->
  <div ng-if="blockedUsersModal.show" class="fixed inset-0 z-[9999] flex items-center justify-center">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm" ng-click="closeBlockedUsersModal()"></div>
    
    <!-- Modal -->
    <div 
      class="relative rounded-xl shadow-2xl border w-full max-w-2xl mx-4"
      style="background-color: var(--bg-secondary); border-color: var(--border-color); max-height: 80vh;"
      ng-click="$event.stopPropagation()"
    >
      <!-- Header -->
      <div class="px-6 py-4 border-b flex items-center justify-between" style="border-color: var(--border-color);">
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
          </svg>
          <h2 class="text-xl font-bold text-white">Blocked Users</h2>
          <span class="text-sm text-gray-400">({{ getFilteredBlockedUsers().length }})</span>
        </div>
        <button 
          ng-click="closeBlockedUsersModal()"
          class="text-gray-400 hover:text-white transition-colors duration-200"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Search Bar -->
      <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
        <div class="relative">
          <input
            type="text"
            ng-model="blockedUsersModal.searchQuery"
            placeholder="Search blocked users..."
            class="w-full px-4 py-2.5 pl-10 rounded-lg border focus:outline-none focus:ring-2 focus:border-transparent transition-all duration-200"
            style="background-color: #000000; border-color: var(--border-color); color: var(--text-primary); --tw-ring-color: var(--text-primary);"
          >
          <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <!-- Blocked Users List -->
      <div class="overflow-y-auto" style="max-height: calc(80vh - 200px);">
        <!-- Loading State -->
        <div ng-if="blockedUsersModal.loading" class="p-12 text-center">
          <div class="animate-spin w-12 h-12 border-4 border-t-transparent rounded-full mx-auto mb-4" style="border-color: var(--text-primary); border-top-color: transparent;"></div>
          <p class="text-gray-400">Loading blocked users...</p>
        </div>
        
        <!-- Empty State -->
        <div ng-if="!blockedUsersModal.loading && getFilteredBlockedUsers().length === 0 && !blockedUsersModal.searchQuery" class="p-12 text-center">
          <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h3 class="text-lg font-semibold text-white mb-2">No Blocked Users</h3>
          <p class="text-gray-400">You haven't blocked anyone yet</p>
        </div>
        
        <!-- No Search Results -->
        <div ng-if="!blockedUsersModal.loading && getFilteredBlockedUsers().length === 0 && blockedUsersModal.searchQuery" class="p-12 text-center">
          <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <h3 class="text-lg font-semibold text-white mb-2">No Results Found</h3>
          <p class="text-gray-400">No blocked users match "{{ blockedUsersModal.searchQuery }}"</p>
        </div>
        
        <!-- Blocked Users -->
        <div ng-if="!blockedUsersModal.loading && getFilteredBlockedUsers().length > 0" class="divide-y" style="divide-color: var(--border-color);">
          <div
            ng-repeat="user in getFilteredBlockedUsers()"
            class="px-6 py-4 hover:bg-gray-800/30 transition-colors duration-200 flex items-center justify-between"
          >
            <div class="flex items-center space-x-4 flex-1 min-w-0">
              <!-- Profile Picture -->
              <img
                ng-src="{{ getProfilePicture(user.profile_picture) }}"
                auth-image="{{ getProfilePicture(user.profile_picture) }}"
                alt="{{ user.name }}"
                class="w-12 h-12 rounded-full flex-shrink-0"
              >
              <div class="flex-1 min-w-0">
                <!-- Name -->
                <p class="text-sm font-semibold text-white truncate">
                  {{ user.name || user.username }}
                </p>
                <!-- Username -->
                <p class="text-xs text-gray-400 truncate">
                  @{{ user.username }}
                </p>
                <!-- Blocked Date -->
                <p class="text-xs text-gray-500 mt-0.5">
                  Blocked {{ user.blocked_at | discordTime }}
                </p>
              </div>
            </div>
            
            <!-- Unblock Button -->
            <button
              ng-click="unblockUser(user)"
              ng-disabled="user.unblocking"
              class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center space-x-2 flex-shrink-0"
              ng-class="user.unblocking ? 'bg-gray-700 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'"
              style="color: white;"
            >
              <svg ng-if="!user.unblocking" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
              </svg>
              <div ng-if="user.unblocking" class="animate-spin w-4 h-4 border-2 border-t-transparent rounded-full" style="border-color: white; border-top-color: transparent;"></div>
              <span>{{ user.unblocking ? 'Unblocking...' : 'Unblock' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
